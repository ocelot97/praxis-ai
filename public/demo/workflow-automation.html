<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Workflow Automation Demo â€” Praxis AI</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Caveat:wght@700&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --terracotta: #C15F3C;
    --terracotta-light: #d4805f;
    --terracotta-glow: rgba(193, 95, 60, 0.35);
    --cream: #F4F3EE;
    --charcoal: #141413;
    --mid: #b0aea5;
    --border: #e8e6dc;
    --green: #3a9a5c;
    --green-light: #e6f5ec;
    --yellow: #c9a227;
    --yellow-light: #fdf6e0;
    --blue: #3b7dd8;
    --blue-light: #e8f0fc;
    --purple: #7c5cbf;
    --purple-light: #f0ebf8;
    --node-shadow: 0 2px 12px rgba(20, 20, 19, 0.06), 0 1px 3px rgba(20, 20, 19, 0.08);
    --node-shadow-active: 0 4px 24px rgba(20, 20, 19, 0.10), 0 2px 8px rgba(20, 20, 19, 0.12);
  }

  body {
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    background: var(--cream);
    color: var(--charcoal);
    line-height: 1.5;
    overflow-x: hidden;
    min-height: 100vh;
  }

  /* === HEADER === */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 40px;
    border-bottom: 1px solid var(--border);
    background: rgba(244, 243, 238, 0.85);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: 20px;
  }

  .logo {
    font-family: 'Caveat', cursive;
    font-size: 28px;
    font-weight: 700;
    color: var(--terracotta);
    letter-spacing: -0.5px;
  }

  .header-divider {
    width: 1px;
    height: 28px;
    background: var(--border);
  }

  .header-title {
    font-size: 15px;
    font-weight: 500;
    color: var(--mid);
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .badge-live {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--green);
    background: var(--green-light);
    padding: 5px 12px;
    border-radius: 100px;
  }

  .badge-live::before {
    content: '';
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--green);
    animation: pulse-dot 2s ease-in-out infinite;
  }

  @keyframes pulse-dot {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  /* === TEMPLATE SELECTOR === */
  .template-bar {
    padding: 20px 40px;
    border-bottom: 1px solid var(--border);
    background: #fff;
  }

  .template-bar-label {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--mid);
    margin-bottom: 12px;
  }

  .template-cards {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }

  .template-card {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 18px;
    border-radius: 10px;
    border: 1.5px solid var(--border);
    cursor: pointer;
    transition: all 0.2s ease;
    background: #fff;
    position: relative;
    user-select: none;
  }

  .template-card:hover {
    border-color: var(--mid);
  }

  .template-card.active {
    border-color: var(--terracotta);
    background: rgba(193, 95, 60, 0.04);
    box-shadow: 0 0 0 3px rgba(193, 95, 60, 0.08);
  }

  .template-card .t-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
  }

  .template-card.active .t-icon { background: rgba(193, 95, 60, 0.12); }
  .template-card:not(.active) .t-icon { background: rgba(176, 174, 165, 0.12); }

  .template-card .t-label {
    font-size: 13px;
    font-weight: 600;
    color: var(--charcoal);
  }

  .template-card:not(.active) .t-label { color: var(--mid); }

  .coming-soon {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    background: var(--border);
    color: var(--mid);
    padding: 2px 7px;
    border-radius: 4px;
    margin-left: 2px;
  }

  /* === MAIN CANVAS === */
  .canvas-wrapper {
    padding: 40px;
    overflow-x: auto;
    min-height: 520px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .canvas {
    position: relative;
    width: 1100px;
    min-height: 460px;
    flex-shrink: 0;
  }

  /* === WORKFLOW NODES === */
  .node {
    position: absolute;
    background: #fff;
    border-radius: 14px;
    box-shadow: var(--node-shadow);
    border: 1.5px solid var(--border);
    padding: 16px 18px;
    width: 190px;
    transition: all 0.35s ease, box-shadow 0.35s ease, border-color 0.35s ease;
    z-index: 2;
    cursor: default;
  }

  .node:hover {
    box-shadow: var(--node-shadow-active);
    transform: translateY(-1px);
  }

  .node.executing {
    border-color: var(--terracotta);
    box-shadow: 0 0 0 3px var(--terracotta-glow), var(--node-shadow-active);
  }

  .node.completed {
    border-color: var(--green);
    box-shadow: 0 0 0 3px rgba(58, 154, 92, 0.15), var(--node-shadow);
  }

  .node-icon {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    margin-bottom: 10px;
  }

  .node-title {
    font-size: 13px;
    font-weight: 650;
    margin-bottom: 3px;
    color: var(--charcoal);
  }

  .node-desc {
    font-size: 11px;
    color: var(--mid);
    line-height: 1.45;
  }

  .node-status {
    margin-top: 8px;
    font-size: 11px;
    font-weight: 600;
    display: none;
    align-items: center;
    gap: 4px;
  }

  .node.executing .node-status,
  .node.completed .node-status {
    display: flex;
  }

  .node.executing .node-status {
    color: var(--terracotta);
  }

  .node.completed .node-status {
    color: var(--green);
  }

  .status-spinner {
    width: 12px;
    height: 12px;
    border: 2px solid var(--terracotta-glow);
    border-top-color: var(--terracotta);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    display: none;
  }

  .node.executing .status-spinner { display: block; }
  .node.completed .status-spinner { display: none; }

  /* Decision node special shape */
  .node.decision {
    width: 170px;
    text-align: center;
    background: linear-gradient(135deg, #fffef8, #fff);
  }

  .node.decision .node-icon { margin: 0 auto 10px; }

  /* Node accent colors */
  .accent-green .node-icon { background: var(--green-light); }
  .accent-terracotta .node-icon { background: rgba(193, 95, 60, 0.1); }
  .accent-yellow .node-icon { background: var(--yellow-light); }
  .accent-blue .node-icon { background: var(--blue-light); }
  .accent-purple .node-icon { background: var(--purple-light); }

  .accent-green.executing { border-color: var(--green); box-shadow: 0 0 0 3px rgba(58, 154, 92, 0.2), var(--node-shadow-active); }
  .accent-terracotta.executing { border-color: var(--terracotta); box-shadow: 0 0 0 3px var(--terracotta-glow), var(--node-shadow-active); }
  .accent-yellow.executing { border-color: var(--yellow); box-shadow: 0 0 0 3px rgba(201, 162, 39, 0.2), var(--node-shadow-active); }
  .accent-blue.executing { border-color: var(--blue); box-shadow: 0 0 0 3px rgba(59, 125, 216, 0.2), var(--node-shadow-active); }
  .accent-purple.executing { border-color: var(--purple); box-shadow: 0 0 0 3px rgba(124, 92, 191, 0.2), var(--node-shadow-active); }

  /* === SVG CONNECTIONS === */
  .connections-svg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 1;
  }

  .connection-line {
    fill: none;
    stroke: var(--border);
    stroke-width: 2;
    stroke-dasharray: 8 4;
    animation: dash-flow 1s linear infinite;
  }

  .connection-line.active {
    stroke: var(--terracotta);
    stroke-width: 2.5;
    filter: drop-shadow(0 0 4px var(--terracotta-glow));
  }

  .connection-line.completed {
    stroke: var(--green);
    stroke-width: 2;
    stroke-dasharray: none;
    animation: none;
  }

  .connection-line.no-path {
    stroke: var(--mid);
    opacity: 0.5;
  }

  .connection-line.no-path.active {
    stroke: var(--mid);
    opacity: 0.6;
    filter: none;
  }

  @keyframes dash-flow {
    to { stroke-dashoffset: -12; }
  }

  .connection-arrow {
    fill: var(--border);
    transition: fill 0.3s ease;
  }

  .connection-arrow.active { fill: var(--terracotta); }
  .connection-arrow.completed { fill: var(--green); }

  /* Branch labels */
  .branch-label {
    position: absolute;
    font-size: 11px;
    font-weight: 700;
    padding: 2px 8px;
    border-radius: 4px;
    z-index: 3;
    letter-spacing: 0.3px;
  }

  .branch-label.yes {
    color: var(--green);
    background: var(--green-light);
  }

  .branch-label.no {
    color: #c0392b;
    background: #fdecea;
  }

  /* === TRAVELLING PULSE === */
  .travel-pulse {
    position: absolute;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--terracotta);
    box-shadow: 0 0 12px var(--terracotta-glow), 0 0 24px rgba(193, 95, 60, 0.2);
    z-index: 10;
    display: none;
    pointer-events: none;
    transform: translate(-50%, -50%);
  }

  .travel-pulse.visible { display: block; }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* === RUN BUTTON === */
  .run-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px 40px;
    gap: 16px;
  }

  .btn-run {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 32px;
    background: var(--terracotta);
    color: #fff;
    border: none;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 650;
    font-family: inherit;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(193, 95, 60, 0.25);
  }

  .btn-run:hover:not(:disabled) {
    background: var(--terracotta-light);
    box-shadow: 0 4px 16px rgba(193, 95, 60, 0.3);
    transform: translateY(-1px);
  }

  .btn-run:active:not(:disabled) {
    transform: translateY(0);
  }

  .btn-run:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .btn-run .play-icon {
    width: 0;
    height: 0;
    border-left: 8px solid #fff;
    border-top: 5px solid transparent;
    border-bottom: 5px solid transparent;
    flex-shrink: 0;
  }

  .run-result {
    display: none;
    align-items: center;
    gap: 10px;
    padding: 12px 20px;
    border-radius: 10px;
    background: var(--green-light);
    border: 1px solid rgba(58, 154, 92, 0.2);
    font-size: 13px;
    font-weight: 500;
    color: #2d7a47;
    animation: fadeSlideUp 0.5s ease;
  }

  .run-result.visible { display: flex; }

  @keyframes fadeSlideUp {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .result-icon {
    width: 28px;
    height: 28px;
    background: var(--green);
    color: #fff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 700;
    flex-shrink: 0;
  }

  /* === STATS PANEL === */
  .stats-panel {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    padding: 24px 40px 40px;
    max-width: 900px;
    margin: 0 auto;
  }

  .stat-card {
    background: #fff;
    border-radius: 12px;
    padding: 20px;
    border: 1px solid var(--border);
    text-align: center;
    transition: box-shadow 0.2s ease;
  }

  .stat-card:hover {
    box-shadow: var(--node-shadow-active);
  }

  .stat-value {
    font-size: 26px;
    font-weight: 700;
    color: var(--charcoal);
    letter-spacing: -0.5px;
  }

  .stat-label {
    font-size: 12px;
    color: var(--mid);
    margin-top: 4px;
    font-weight: 500;
  }

  .stat-card:nth-child(1) .stat-value { color: var(--terracotta); }
  .stat-card:nth-child(2) .stat-value { color: var(--charcoal); }
  .stat-card:nth-child(3) .stat-value { color: var(--green); }
  .stat-card:nth-child(4) .stat-value { color: var(--blue); }

  /* === RESPONSIVE === */
  @media (max-width: 1200px) {
    .canvas-wrapper {
      align-items: flex-start;
    }
  }

  @media (max-width: 768px) {
    .header {
      padding: 16px 20px;
      flex-wrap: wrap;
      gap: 8px;
    }

    .template-bar { padding: 16px 20px; }
    .canvas-wrapper { padding: 20px; }

    .stats-panel {
      grid-template-columns: repeat(2, 1fr);
      padding: 20px;
    }

    .run-bar {
      flex-direction: column;
      padding: 20px;
    }
  }

  @media (max-width: 480px) {
    .stats-panel { grid-template-columns: 1fr; }
    .header-divider { display: none; }
    .header-title { display: none; }
  }

  /* === DECISION THINKING ANIMATION === */
  .thinking-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    border-radius: 14px;
    background: rgba(201, 162, 39, 0.05);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 5;
  }

  .thinking-overlay.visible {
    display: flex;
  }

  .thinking-dots {
    display: flex;
    gap: 4px;
  }

  .thinking-dots span {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--yellow);
    animation: thinking-bounce 1.2s ease-in-out infinite;
  }

  .thinking-dots span:nth-child(2) { animation-delay: 0.15s; }
  .thinking-dots span:nth-child(3) { animation-delay: 0.3s; }

  @keyframes thinking-bounce {
    0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
    30% { transform: translateY(-6px); opacity: 1; }
  }

  /* === FOOTER === */
  .footer {
    text-align: center;
    padding: 20px 40px 32px;
    font-size: 12px;
    color: var(--mid);
  }

  .footer a {
    color: var(--terracotta);
    text-decoration: none;
    font-weight: 600;
  }
</style>
</head>
<body>

<!-- HEADER -->
<header class="header">
  <div class="header-left">
    <div class="logo">Praxis AI</div>
    <div class="header-divider"></div>
    <div class="header-title">Workflow Automation &mdash; Demo</div>
  </div>
  <div class="header-right">
    <div class="badge-live">Live Preview</div>
  </div>
</header>

<!-- TEMPLATE SELECTOR -->
<div class="template-bar">
  <div class="template-bar-label">Workflow Templates</div>
  <div class="template-cards">
    <div class="template-card active" data-template="lead">
      <div class="t-icon">&#x1F3AF;</div>
      <div class="t-label">Lead Qualification</div>
    </div>
    <div class="template-card" data-template="invoice">
      <div class="t-icon">&#x1F4C4;</div>
      <div class="t-label">Invoice Processing</div>
      <span class="coming-soon">Soon</span>
    </div>
    <div class="template-card" data-template="support">
      <div class="t-icon">&#x1F3AB;</div>
      <div class="t-label">Support Ticket Routing</div>
      <span class="coming-soon">Soon</span>
    </div>
  </div>
</div>

<!-- WORKFLOW CANVAS -->
<div class="canvas-wrapper">
  <div class="canvas" id="canvas">
    <!-- SVG connections drawn by JS -->
    <svg class="connections-svg" id="connectionsSvg">
      <defs>
        <marker id="arrow-default" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
          <polygon points="0 0, 8 3, 0 6" class="connection-arrow" />
        </marker>
        <marker id="arrow-active" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
          <polygon points="0 0, 8 3, 0 6" class="connection-arrow active" />
        </marker>
        <marker id="arrow-completed" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
          <polygon points="0 0, 8 3, 0 6" class="connection-arrow completed" />
        </marker>
      </defs>
    </svg>

    <!-- NODES -->
    <!-- Row 1: Trigger -->
    <div class="node accent-green" id="node-trigger" style="left: 0px; top: 60px;">
      <div class="node-icon">&#x26A1;</div>
      <div class="node-title">New Lead Received</div>
      <div class="node-desc">From website form, email, or CRM</div>
      <div class="node-status"><div class="status-spinner"></div><span class="status-text">Processing...</span></div>
    </div>

    <!-- Row 1: AI Scoring -->
    <div class="node accent-terracotta" id="node-ai" style="left: 240px; top: 60px;">
      <div class="node-icon">&#x1F9E0;</div>
      <div class="node-title">AI Lead Scoring</div>
      <div class="node-desc">Analyze company size, industry, intent signals</div>
      <div class="node-status"><div class="status-spinner"></div><span class="status-text">Processing...</span></div>
    </div>

    <!-- Row 1: Decision -->
    <div class="node decision accent-yellow" id="node-decision" style="left: 480px; top: 55px;">
      <div class="node-icon">&#x2696;&#xFE0F;</div>
      <div class="node-title">Score &gt; 70?</div>
      <div class="node-desc">AI confidence threshold</div>
      <div class="node-status"><div class="status-spinner"></div><span class="status-text">Processing...</span></div>
      <div class="thinking-overlay" id="thinkingOverlay">
        <div class="thinking-dots"><span></span><span></span><span></span></div>
      </div>
    </div>

    <!-- Branch labels -->
    <div class="branch-label yes" id="label-yes" style="left: 632px; top: 34px;">YES</div>
    <div class="branch-label no" id="label-no" style="left: 632px; top: 210px;">NO</div>

    <!-- YES PATH -->
    <div class="node accent-blue" id="node-enrich" style="left: 700px; top: 0px;">
      <div class="node-icon">&#x1F50D;</div>
      <div class="node-title">Enrich Data</div>
      <div class="node-desc">Pull company info from LinkedIn, Clearbit</div>
      <div class="node-status"><div class="status-spinner"></div><span class="status-text">Processing...</span></div>
    </div>

    <div class="node accent-blue" id="node-assign" style="left: 700px; top: 130px;">
      <div class="node-icon">&#x1F464;</div>
      <div class="node-title">Assign to Sales Rep</div>
      <div class="node-desc">Route to available rep by territory</div>
      <div class="node-status"><div class="status-spinner"></div><span class="status-text">Processing...</span></div>
    </div>

    <div class="node accent-purple" id="node-email" style="left: 930px; top: 65px;">
      <div class="node-icon">&#x2709;&#xFE0F;</div>
      <div class="node-title">Send Welcome Email</div>
      <div class="node-desc">Personalized email via template</div>
      <div class="node-status"><div class="status-spinner"></div><span class="status-text">Processing...</span></div>
    </div>

    <!-- NO PATH -->
    <div class="node accent-blue" id="node-nurture" style="left: 700px; top: 270px;">
      <div class="node-icon">&#x1F4E7;</div>
      <div class="node-title">Add to Nurture Campaign</div>
      <div class="node-desc">Automated drip email sequence</div>
      <div class="node-status"><div class="status-spinner"></div><span class="status-text">Processing...</span></div>
    </div>

    <div class="node accent-purple" id="node-rescore" style="left: 930px; top: 270px;">
      <div class="node-icon">&#x1F504;</div>
      <div class="node-title">Re-score in 30 Days</div>
      <div class="node-desc">Schedule re-evaluation</div>
      <div class="node-status"><div class="status-spinner"></div><span class="status-text">Processing...</span></div>
    </div>

    <!-- Travelling pulse -->
    <div class="travel-pulse" id="travelPulse"></div>
  </div>
</div>

<!-- RUN BUTTON & RESULT -->
<div class="run-bar">
  <button class="btn-run" id="btnRun">
    <span class="play-icon"></span>
    Run Workflow
  </button>
  <div class="run-result" id="runResult">
    <div class="result-icon">&#x2713;</div>
    <span>Lead qualified! Score: <strong>85/100</strong> &rarr; Assigned to <strong>Sarah M.</strong> &mdash; Welcome email sent.</span>
  </div>
</div>

<!-- STATS PANEL -->
<div class="stats-panel">
  <div class="stat-card">
    <div class="stat-value" id="statTime">2.3s</div>
    <div class="stat-label">Avg. processing time</div>
  </div>
  <div class="stat-card">
    <div class="stat-value" id="statLeads">847</div>
    <div class="stat-label">Leads processed today</div>
  </div>
  <div class="stat-card">
    <div class="stat-value" id="statRate">94%</div>
    <div class="stat-label">Automation rate</div>
  </div>
  <div class="stat-card">
    <div class="stat-value" id="statSavings">$12,400/mo</div>
    <div class="stat-label">Cost savings</div>
  </div>
</div>

<div class="footer">
  Built with <a href="#">Praxis AI</a> &mdash; No-code workflow automation powered by artificial intelligence.
</div>

<script>
(function() {
  'use strict';

  // --- NODE POSITIONS HELPER ---
  // Returns center point of a node element
  function getNodeCenter(id) {
    const el = document.getElementById(id);
    if (!el) return { x: 0, y: 0 };
    const left = parseFloat(el.style.left);
    const top = parseFloat(el.style.top);
    const w = el.offsetWidth;
    const h = el.offsetHeight;
    return { x: left + w / 2, y: top + h / 2 };
  }

  function getNodeRight(id) {
    const el = document.getElementById(id);
    const left = parseFloat(el.style.left);
    const top = parseFloat(el.style.top);
    return { x: left + el.offsetWidth, y: top + el.offsetHeight / 2 };
  }

  function getNodeLeft(id) {
    const el = document.getElementById(id);
    const left = parseFloat(el.style.left);
    const top = parseFloat(el.style.top);
    return { x: left, y: top + el.offsetHeight / 2 };
  }

  function getNodeBottom(id) {
    const el = document.getElementById(id);
    const left = parseFloat(el.style.left);
    const top = parseFloat(el.style.top);
    return { x: left + el.offsetWidth / 2, y: top + el.offsetHeight };
  }

  function getNodeTop(id) {
    const el = document.getElementById(id);
    const left = parseFloat(el.style.left);
    const top = parseFloat(el.style.top);
    return { x: left + el.offsetWidth / 2, y: top };
  }

  // --- DRAW CONNECTIONS ---
  const connections = [];

  function createPath(from, to, type) {
    const svg = document.getElementById('connectionsSvg');
    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');

    const dx = to.x - from.x;
    const dy = to.y - from.y;

    // Cubic bezier for smooth curves
    let cx1, cy1, cx2, cy2;
    if (Math.abs(dx) > Math.abs(dy)) {
      // Primarily horizontal
      cx1 = from.x + dx * 0.5;
      cy1 = from.y;
      cx2 = from.x + dx * 0.5;
      cy2 = to.y;
    } else {
      cx1 = from.x;
      cy1 = from.y + dy * 0.5;
      cx2 = to.x;
      cy2 = from.y + dy * 0.5;
    }

    const d = `M ${from.x} ${from.y} C ${cx1} ${cy1}, ${cx2} ${cy2}, ${to.x} ${to.y}`;
    path.setAttribute('d', d);
    path.setAttribute('class', 'connection-line' + (type === 'no' ? ' no-path' : ''));
    path.setAttribute('marker-end', 'url(#arrow-default)');
    svg.appendChild(path);

    return { path, from, to, type: type || 'default' };
  }

  function drawAllConnections() {
    // Clear existing
    const svg = document.getElementById('connectionsSvg');
    while (svg.children.length > 1) {
      svg.removeChild(svg.lastChild);
    }
    connections.length = 0;

    // Wait for layout
    requestAnimationFrame(function() {
      // Trigger -> AI
      connections.push({
        ...createPath(getNodeRight('node-trigger'), getNodeLeft('node-ai'), 'yes'),
        id: 'trigger-ai'
      });

      // AI -> Decision
      connections.push({
        ...createPath(getNodeRight('node-ai'), getNodeLeft('node-decision'), 'yes'),
        id: 'ai-decision'
      });

      // Decision -> Enrich (YES path, up-right)
      const decRight = getNodeRight('node-decision');
      const enrichLeft = getNodeLeft('node-enrich');
      connections.push({
        ...createPath(
          { x: decRight.x, y: decRight.y - 15 },
          enrichLeft,
          'yes'
        ),
        id: 'decision-enrich'
      });

      // Decision -> Assign (YES path, right)
      const assignLeft = getNodeLeft('node-assign');
      connections.push({
        ...createPath(
          { x: decRight.x, y: decRight.y + 5 },
          assignLeft,
          'yes'
        ),
        id: 'decision-assign'
      });

      // Enrich -> Email
      connections.push({
        ...createPath(getNodeRight('node-enrich'), getNodeLeft('node-email'),  'yes'),
        id: 'enrich-email'
      });

      // Assign -> Email
      connections.push({
        ...createPath(getNodeRight('node-assign'), { x: getNodeLeft('node-email').x, y: getNodeLeft('node-email').y + 10 }, 'yes'),
        id: 'assign-email'
      });

      // Decision -> Nurture (NO path, down-right)
      const nurtureLeft = getNodeLeft('node-nurture');
      connections.push({
        ...createPath(
          { x: decRight.x, y: decRight.y + 20 },
          nurtureLeft,
          'no'
        ),
        id: 'decision-nurture'
      });

      // Nurture -> Rescore
      connections.push({
        ...createPath(getNodeRight('node-nurture'), getNodeLeft('node-rescore'), 'no'),
        id: 'nurture-rescore'
      });
    });
  }

  drawAllConnections();
  window.addEventListener('resize', drawAllConnections);

  // --- TEMPLATE SELECTOR ---
  document.querySelectorAll('.template-card').forEach(function(card) {
    card.addEventListener('click', function() {
      if (card.dataset.template !== 'lead') return;
      document.querySelectorAll('.template-card').forEach(function(c) { c.classList.remove('active'); });
      card.classList.add('active');
    });
  });

  // --- EXECUTION ANIMATION ---
  const btnRun = document.getElementById('btnRun');
  const runResult = document.getElementById('runResult');
  const travelPulse = document.getElementById('travelPulse');
  let isRunning = false;

  // Execution sequence for YES path
  const yesPathSequence = [
    { node: 'node-trigger', duration: 600, connections: [] },
    { node: 'node-ai', duration: 1200, connections: ['trigger-ai'] },
    { node: 'node-decision', duration: 1500, connections: ['ai-decision'], thinking: true },
    { node: 'node-enrich', duration: 800, connections: ['decision-enrich'], parallel: 'node-assign', parallelConn: 'decision-assign' },
    { node: 'node-email', duration: 700, connections: ['enrich-email', 'assign-email'] },
  ];

  function resetAllNodes() {
    document.querySelectorAll('.node').forEach(function(n) {
      n.classList.remove('executing', 'completed');
      n.querySelector('.status-text').textContent = 'Processing...';
    });
    connections.forEach(function(c) {
      c.path.classList.remove('active', 'completed');
      c.path.setAttribute('marker-end', 'url(#arrow-default)');
    });
    runResult.classList.remove('visible');
    travelPulse.classList.remove('visible');
    document.getElementById('thinkingOverlay').classList.remove('visible');
  }

  function setNodeExecuting(nodeId) {
    const el = document.getElementById(nodeId);
    el.classList.add('executing');
    el.querySelector('.status-text').textContent = 'Processing...';
  }

  function setNodeComplete(nodeId) {
    const el = document.getElementById(nodeId);
    el.classList.remove('executing');
    el.classList.add('completed');
    el.querySelector('.status-text').textContent = 'Complete \u2713';
  }

  function activateConnection(connId) {
    const conn = connections.find(function(c) { return c.id === connId; });
    if (conn) {
      conn.path.classList.add('active');
      conn.path.setAttribute('marker-end', 'url(#arrow-active)');
    }
  }

  function completeConnection(connId) {
    const conn = connections.find(function(c) { return c.id === connId; });
    if (conn) {
      conn.path.classList.remove('active');
      conn.path.classList.add('completed');
      conn.path.setAttribute('marker-end', 'url(#arrow-completed)');
    }
  }

  // Animate pulse travelling along a path
  function animatePulseAlongPath(connId, duration) {
    return new Promise(function(resolve) {
      const conn = connections.find(function(c) { return c.id === connId; });
      if (!conn) { resolve(); return; }

      const pathEl = conn.path;
      const totalLength = pathEl.getTotalLength();
      travelPulse.classList.add('visible');

      const startTime = performance.now();

      function step(timestamp) {
        const elapsed = timestamp - startTime;
        const progress = Math.min(elapsed / duration, 1);

        // Ease in-out
        const eased = progress < 0.5
          ? 2 * progress * progress
          : 1 - Math.pow(-2 * progress + 2, 2) / 2;

        const point = pathEl.getPointAtLength(eased * totalLength);
        travelPulse.style.left = point.x + 'px';
        travelPulse.style.top = point.y + 'px';

        if (progress < 1) {
          requestAnimationFrame(step);
        } else {
          travelPulse.classList.remove('visible');
          resolve();
        }
      }

      requestAnimationFrame(step);
    });
  }

  function delay(ms) {
    return new Promise(function(resolve) { setTimeout(resolve, ms); });
  }

  async function runWorkflow() {
    if (isRunning) return;
    isRunning = true;
    btnRun.disabled = true;
    btnRun.innerHTML = '<div class="status-spinner" style="display:block;border-color:rgba(255,255,255,0.3);border-top-color:#fff;width:14px;height:14px;"></div> Running...';
    resetAllNodes();

    await delay(300);

    // Step 1: Trigger
    setNodeExecuting('node-trigger');
    await delay(600);
    setNodeComplete('node-trigger');

    // Step 2: AI Scoring (with pulse travel)
    activateConnection('trigger-ai');
    await animatePulseAlongPath('trigger-ai', 500);
    completeConnection('trigger-ai');
    setNodeExecuting('node-ai');
    await delay(1200);
    setNodeComplete('node-ai');

    // Step 3: Decision (with thinking animation)
    activateConnection('ai-decision');
    await animatePulseAlongPath('ai-decision', 500);
    completeConnection('ai-decision');
    setNodeExecuting('node-decision');
    document.getElementById('thinkingOverlay').classList.add('visible');
    document.getElementById('node-decision').querySelector('.status-text').textContent = 'Analyzing...';
    await delay(1500);
    document.getElementById('thinkingOverlay').classList.remove('visible');
    document.getElementById('node-decision').querySelector('.status-text').textContent = 'Score: 85 \u2192 YES';
    await delay(400);
    setNodeComplete('node-decision');

    // Step 4: Parallel - Enrich + Assign (YES path)
    activateConnection('decision-enrich');
    activateConnection('decision-assign');

    // Animate pulses in parallel
    await Promise.all([
      animatePulseAlongPath('decision-enrich', 450),
      (async function() { await delay(100); await animatePulseAlongPath('decision-assign', 500); })()
    ]);

    completeConnection('decision-enrich');
    completeConnection('decision-assign');

    setNodeExecuting('node-enrich');
    setNodeExecuting('node-assign');
    await delay(800);
    setNodeComplete('node-enrich');
    await delay(200);
    setNodeComplete('node-assign');

    // Step 5: Send Email
    activateConnection('enrich-email');
    activateConnection('assign-email');
    await animatePulseAlongPath('enrich-email', 400);
    completeConnection('enrich-email');
    completeConnection('assign-email');
    setNodeExecuting('node-email');
    await delay(700);
    setNodeComplete('node-email');

    // Show result
    await delay(300);
    runResult.classList.add('visible');

    // Increment stats
    const leadsEl = document.getElementById('statLeads');
    const currentLeads = parseInt(leadsEl.textContent);
    leadsEl.textContent = (currentLeads + 1).toLocaleString();

    btnRun.innerHTML = '<span class="play-icon"></span> Run Again';
    btnRun.disabled = false;
    isRunning = false;
  }

  btnRun.addEventListener('click', function() {
    resetAllNodes();
    runWorkflow();
  });

  // --- COUNTER ANIMATIONS ---
  function animateCounter(el, target, suffix, duration) {
    suffix = suffix || '';
    duration = duration || 1200;
    const start = 0;
    const startTime = performance.now();

    function step(timestamp) {
      const elapsed = timestamp - startTime;
      const progress = Math.min(elapsed / duration, 1);
      const eased = 1 - Math.pow(1 - progress, 3);
      const current = Math.round(start + (target - start) * eased);

      if (suffix === '$') {
        el.textContent = '$' + current.toLocaleString() + '/mo';
      } else if (suffix === '%') {
        el.textContent = current + '%';
      } else if (suffix === 's') {
        el.textContent = (current / 10).toFixed(1) + 's';
      } else {
        el.textContent = current.toLocaleString();
      }

      if (progress < 1) requestAnimationFrame(step);
    }

    requestAnimationFrame(step);
  }

  // IntersectionObserver for stats
  const statsObserver = new IntersectionObserver(function(entries) {
    entries.forEach(function(entry) {
      if (entry.isIntersecting) {
        animateCounter(document.getElementById('statTime'), 23, 's');
        animateCounter(document.getElementById('statLeads'), 847, '');
        animateCounter(document.getElementById('statRate'), 94, '%');
        animateCounter(document.getElementById('statSavings'), 12400, '$');
        statsObserver.disconnect();
      }
    });
  }, { threshold: 0.3 });

  statsObserver.observe(document.querySelector('.stats-panel'));
})();
</script>
</body>
</html>
