<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Elaborazione Fatture Elettroniche — Praxis AI</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Caveat:wght@700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --navy: #0f172a;
  --navy-light: #1e3a5f;
  --navy-muted: #334155;
  --silver: #94a3b8;
  --surface: #f0f4f8;
  --surface-light: #f8fafc;
  --surface-dark: #e2e8f0;
  --ice: #fafbfd;
  --border: #cbd5e1;
  --white: #ffffff;
  --accent-green: #16a34a;
  --accent-amber: #d97706;
  --accent-red: #dc2626;
  --font-body: 'Inter', system-ui, sans-serif;
  --font-display: 'Caveat', cursive;
}

html { font-size: 16px; }

body {
  font-family: var(--font-body);
  background: var(--surface);
  color: var(--navy);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  overflow-x: hidden;
}

/* ---- HEADER ---- */
.header {
  background: var(--navy);
  color: var(--white);
  padding: 14px 24px;
  display: flex;
  align-items: center;
  gap: 16px;
  flex-shrink: 0;
}
.header-logo {
  font-family: var(--font-display);
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--white);
}
.header-title {
  font-size: 0.95rem;
  font-weight: 500;
  color: var(--silver);
  flex: 1;
}
.header-badge {
  background: var(--navy-light);
  color: var(--silver);
  font-size: 0.65rem;
  font-weight: 700;
  letter-spacing: 0.12em;
  padding: 4px 10px;
  border-radius: 4px;
  text-transform: uppercase;
}

/* ---- PROGRESS ---- */
.progress-wrap {
  background: var(--white);
  border-bottom: 1px solid var(--border);
  padding: 12px 24px;
  display: flex;
  align-items: center;
  gap: 16px;
  flex-shrink: 0;
}
.progress-label {
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--navy-muted);
  white-space: nowrap;
}
.progress-bar {
  flex: 1;
  height: 6px;
  background: var(--surface-dark);
  border-radius: 3px;
  overflow: hidden;
}
.progress-fill {
  height: 100%;
  background: var(--navy-light);
  border-radius: 3px;
  transition: width 0.6s ease;
  width: 25%;
}
.btn-next {
  background: var(--navy);
  color: var(--white);
  border: none;
  padding: 8px 22px;
  border-radius: 6px;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s, transform 0.15s;
  white-space: nowrap;
}
.btn-next:hover { background: var(--navy-light); }
.btn-next:active { transform: scale(0.97); }
.btn-next:disabled { opacity: 0.4; cursor: not-allowed; }

/* ---- MAIN ---- */
.main {
  flex: 1;
  padding: 24px;
  display: flex;
  align-items: flex-start;
  justify-content: center;
  overflow: hidden;
  position: relative;
}

.step { display: none; width: 100%; max-width: 900px; }
.step.active { display: block; }

/* ---- STEP 1 — INVOICE QUEUE ---- */
.invoice-queue {
  position: relative;
  min-height: 340px;
  padding-top: 10px;
}
.invoice-card {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px 20px;
  margin-bottom: 10px;
  box-shadow: 0 2px 8px rgba(15,23,42,0.06), 0 1px 3px rgba(15,23,42,0.04);
  opacity: 0;
  transform: translateX(80px);
  transition: opacity 0.4s ease, transform 0.5s ease;
  position: relative;
}
.invoice-card.visible {
  opacity: 1;
  transform: translateX(0);
}
.invoice-card .inv-number {
  font-weight: 700;
  font-size: 0.9rem;
  color: var(--navy);
}
.invoice-card .inv-detail {
  font-size: 0.82rem;
  color: var(--navy-muted);
  margin-top: 4px;
  line-height: 1.5;
}
.invoice-card .inv-amount {
  font-weight: 700;
  color: var(--navy-light);
}
.queue-counter {
  text-align: center;
  margin-top: 16px;
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--silver);
}

/* ---- STEP 2 — EXTRACTION ---- */
.step2-layout {
  display: flex;
  gap: 24px;
  align-items: flex-start;
}
.extraction-panel {
  flex: 1;
  min-width: 0;
}
.expanded-invoice {
  background: var(--white);
  border: 2px solid var(--navy-light);
  border-radius: 10px;
  padding: 20px;
  position: relative;
  overflow: hidden;
  margin-bottom: 16px;
}
.scanner-line {
  position: absolute;
  left: 0; right: 0;
  height: 3px;
  background: linear-gradient(90deg, transparent 0%, var(--navy-light) 30%, var(--navy) 50%, var(--navy-light) 70%, transparent 100%);
  opacity: 0;
  top: 0;
  z-index: 2;
}
.scanner-line.scanning {
  opacity: 1;
  animation: scanDown 2s ease-in-out forwards;
}
@keyframes scanDown {
  0% { top: 0; }
  100% { top: 100%; }
}
.field-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 7px 0;
  border-bottom: 1px solid var(--surface-dark);
  font-size: 0.82rem;
  opacity: 0.3;
  transition: opacity 0.3s, background 0.3s;
}
.field-row.extracted {
  opacity: 1;
  background: rgba(22,163,74,0.04);
}
.field-label { color: var(--navy-muted); font-weight: 500; }
.field-value { font-weight: 700; color: var(--navy); }
.field-check {
  color: var(--accent-green);
  font-weight: 700;
  margin-left: 8px;
  opacity: 0;
  transition: opacity 0.3s;
}
.field-row.extracted .field-check { opacity: 1; }

.extraction-table-wrap {
  flex: 1;
  min-width: 0;
  overflow-x: auto;
}
.extraction-table {
  width: 100%;
  font-size: 0.75rem;
  border-collapse: collapse;
  background: var(--white);
  border-radius: 8px;
  overflow: hidden;
  border: 1px solid var(--border);
}
.extraction-table th {
  background: var(--navy);
  color: var(--white);
  padding: 8px 10px;
  text-align: left;
  font-weight: 600;
  white-space: nowrap;
}
.extraction-table td {
  padding: 7px 10px;
  border-bottom: 1px solid var(--surface-dark);
  white-space: nowrap;
}
.extraction-table tr.new-row { animation: fadeRow 0.4s ease; }
@keyframes fadeRow {
  from { opacity: 0; background: rgba(30,58,95,0.08); }
  to { opacity: 1; background: transparent; }
}
.batch-counter {
  text-align: center;
  margin-top: 14px;
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--navy-muted);
}

/* Amber flag */
.amber-flag {
  position: absolute;
  top: 10px; right: 10px;
  width: 28px; height: 28px;
  background: var(--accent-amber);
  color: var(--white);
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.85rem;
  font-weight: 700;
  cursor: pointer;
  animation: pulse-amber 1.5s infinite;
  z-index: 5;
}
@keyframes pulse-amber {
  0%,100% { box-shadow: 0 0 0 0 rgba(217,119,6,0.5); }
  50% { box-shadow: 0 0 0 8px rgba(217,119,6,0); }
}
.flag-detail {
  display: none;
  background: #fffbeb;
  border: 1px solid var(--accent-amber);
  border-radius: 8px;
  padding: 16px;
  margin-top: 12px;
  font-size: 0.82rem;
  line-height: 1.6;
  color: var(--navy);
  animation: fadeIn 0.3s ease;
}
.flag-detail.open { display: block; }
.flag-detail-title {
  font-weight: 700;
  color: var(--accent-amber);
  margin-bottom: 8px;
  font-size: 0.9rem;
}
.flag-detail p { margin-bottom: 6px; }
.flag-detail .diff {
  font-weight: 700;
  color: var(--accent-red);
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-6px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ---- STEP 3 — RECONCILIATION ---- */
.recon-table {
  width: 100%;
  font-size: 0.78rem;
  border-collapse: collapse;
  background: var(--white);
  border-radius: 8px;
  overflow: hidden;
  border: 1px solid var(--border);
  margin-bottom: 16px;
}
.recon-table th {
  background: var(--navy);
  color: var(--white);
  padding: 9px 12px;
  text-align: left;
  font-weight: 600;
}
.recon-table td {
  padding: 9px 12px;
  border-bottom: 1px solid var(--surface-dark);
}
.recon-table .match-cell {
  text-align: center;
  font-size: 1.1rem;
}
.match-ok { color: var(--accent-green); }
.match-fail { color: var(--accent-red); animation: pulse-red 1.2s infinite; }
@keyframes pulse-red {
  0%,100% { opacity: 1; }
  50% { opacity: 0.5; }
}
.recon-stats {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px 20px;
  text-align: center;
  font-size: 0.88rem;
  font-weight: 600;
  color: var(--navy-muted);
}
.recon-stats .green { color: var(--accent-green); }
.recon-stats .amber { color: var(--accent-amber); }

/* ---- STEP 4 — F24 ---- */
.f24-form {
  background: var(--white);
  border: 2px solid var(--navy-muted);
  border-radius: 10px;
  overflow: hidden;
  max-width: 680px;
  margin: 0 auto;
}
.f24-header {
  background: var(--navy);
  color: var(--white);
  padding: 14px 20px;
  text-align: center;
  font-weight: 700;
  font-size: 1rem;
  letter-spacing: 0.04em;
}
.f24-section {
  padding: 14px 20px;
  border-bottom: 1px solid var(--border);
  opacity: 0;
  transform: translateY(8px);
  transition: opacity 0.5s, transform 0.5s;
}
.f24-section.visible {
  opacity: 1;
  transform: translateY(0);
}
.f24-section-title {
  font-size: 0.75rem;
  font-weight: 700;
  text-transform: uppercase;
  color: var(--navy-light);
  letter-spacing: 0.08em;
  margin-bottom: 10px;
}
.f24-row {
  display: flex;
  justify-content: space-between;
  padding: 5px 0;
  font-size: 0.82rem;
}
.f24-label { color: var(--navy-muted); }
.f24-value {
  font-weight: 700;
  color: var(--navy);
  min-width: 0;
  text-align: right;
}
.f24-value.filling {
  animation: typeIn 0.6s ease;
}
@keyframes typeIn {
  from { opacity: 0; transform: translateX(10px); }
  to { opacity: 1; transform: translateX(0); }
}
.f24-total {
  background: var(--surface);
  padding: 14px 20px;
  display: flex;
  justify-content: space-between;
  font-weight: 700;
  font-size: 1rem;
  color: var(--navy);
}
.f24-badge {
  text-align: center;
  padding: 18px 20px;
  opacity: 0;
  transition: opacity 0.5s;
}
.f24-badge.visible { opacity: 1; }
.f24-badge-inner {
  display: inline-block;
  background: rgba(22,163,74,0.08);
  border: 1px solid var(--accent-green);
  color: var(--accent-green);
  font-weight: 700;
  font-size: 0.88rem;
  padding: 10px 24px;
  border-radius: 8px;
}
.f24-cta {
  text-align: center;
  padding: 0 20px 20px;
  opacity: 0;
  transition: opacity 0.5s;
}
.f24-cta.visible { opacity: 1; }
.f24-cta a {
  display: inline-block;
  background: var(--navy);
  color: var(--white);
  font-weight: 600;
  font-size: 0.88rem;
  padding: 12px 28px;
  border-radius: 8px;
  text-decoration: none;
  transition: background 0.2s;
}
.f24-cta a:hover { background: var(--navy-light); }

/* ---- RESPONSIVE ---- */
@media (max-width: 700px) {
  .header { padding: 10px 14px; gap: 10px; }
  .header-logo { font-size: 1.2rem; }
  .header-title { font-size: 0.82rem; }
  .main { padding: 14px; }
  .step2-layout { flex-direction: column; }
  .f24-form { max-width: 100%; }
  .extraction-table { font-size: 0.68rem; }
  .recon-table { font-size: 0.72rem; }
}
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="header-logo">Praxis AI</div>
  <div class="header-title" id="headerTitle"></div>
  <div class="header-badge">DEMO</div>
</div>

<!-- PROGRESS -->
<div class="progress-wrap">
  <div class="progress-label" id="progressLabel"></div>
  <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
  <button class="btn-next" id="btnNext"></button>
</div>

<!-- STEPS -->
<div class="main">

  <!-- STEP 1 -->
  <div class="step active" id="step1">
    <div class="invoice-queue" id="invoiceQueue"></div>
    <div class="queue-counter" id="queueCounter"></div>
  </div>

  <!-- STEP 2 -->
  <div class="step" id="step2">
    <div class="step2-layout">
      <div class="extraction-panel" id="extractionPanel"></div>
      <div class="extraction-table-wrap">
        <table class="extraction-table">
          <thead id="extTableHead"></thead>
          <tbody id="extTableBody"></tbody>
        </table>
      </div>
    </div>
    <div class="batch-counter" id="batchCounter"></div>
  </div>

  <!-- STEP 3 -->
  <div class="step" id="step3">
    <table class="recon-table" id="reconTable">
      <thead id="reconHead"></thead>
      <tbody id="reconBody"></tbody>
    </table>
    <div class="recon-stats" id="reconStats"></div>
  </div>

  <!-- STEP 4 -->
  <div class="step" id="step4">
    <div class="f24-form" id="f24Form">
      <div class="f24-header" id="f24Header"></div>
      <div class="f24-section" id="f24Contrib">
        <div class="f24-section-title" id="f24ContribTitle"></div>
        <div id="f24ContribBody"></div>
      </div>
      <div class="f24-section" id="f24Erario">
        <div class="f24-section-title" id="f24ErarioTitle"></div>
        <div id="f24ErarioBody"></div>
      </div>
      <div class="f24-total" id="f24Total"></div>
      <div class="f24-badge" id="f24Badge"></div>
      <div class="f24-cta" id="f24Cta"></div>
    </div>
  </div>

</div>

<script>
(function() {
  'use strict';

  // ---- i18n ----
  var locale = (typeof window.__PRAXIS_LOCALE__ === 'string') ? window.__PRAXIS_LOCALE__ : 'it';
  if (locale !== 'it' && locale !== 'en') locale = 'it';

  var T = {
    pageTitle: { it: 'Elaborazione Fatture Elettroniche', en: 'Electronic Invoice Processing' },
    stepOf: { it: 'Passaggio {n} di 4', en: 'Step {n} of 4' },
    next: { it: 'Avanti', en: 'Next' },
    queueCounter: { it: '{n} fatture in coda', en: '{n} invoices in queue' },
    batchCounter: { it: '{a}/{b} elaborate', en: '{a}/{b} processed' },
    thFornitore: { it: 'Fornitore', en: 'Supplier' },
    thPIVA: { it: 'P.IVA', en: 'VAT No.' },
    thNetto: { it: 'Netto', en: 'Net' },
    thIVA: { it: 'IVA', en: 'VAT' },
    thTotale: { it: 'Totale', en: 'Total' },
    ragioneSociale: { it: 'Ragione Sociale', en: 'Company Name' },
    piva: { it: 'P.IVA', en: 'VAT No.' },
    codDestinatario: { it: 'Codice Destinatario', en: 'Recipient Code' },
    importoNetto: { it: 'Importo Netto', en: 'Net Amount' },
    aliquotaIva: { it: 'Aliquota IVA', en: 'VAT Rate' },
    importoIva: { it: 'Importo IVA', en: 'VAT Amount' },
    totaleFattura: { it: 'Totale Fattura', en: 'Invoice Total' },
    flagTitle: { it: '\u26A0 Aliquota IVA da Verificare', en: '\u26A0 VAT Rate to Verify' },
    flagBody1: { it: 'Aliquota IVA 10% applicata su forniture per ufficio. Categoria merceologica generalmente soggetta ad aliquota ordinaria 22%.', en: 'VAT rate of 10% applied to office supplies. Product category generally subject to standard 22% rate.' },
    flagBody2: { it: "Verificare se l'aliquota ridotta \u00e8 applicabile in base all'Art. 16 D.P.R. 633/72.", en: 'Verify whether the reduced rate is applicable under Art. 16 D.P.R. 633/72.' },
    flagBody3: { it: 'Differenza potenziale: \u20AC135,00 di IVA non contabilizzata.', en: 'Potential difference: \u20AC135.00 of unaccounted VAT.' },
    reconFattura: { it: 'Fattura', en: 'Invoice' },
    reconFornitore: { it: 'Fornitore', en: 'Supplier' },
    reconImporto: { it: 'Importo', en: 'Amount' },
    reconPrimaNota: { it: 'Prima Nota', en: 'Journal Entry' },
    reconStato: { it: 'Stato', en: 'Status' },
    reconFound: { it: 'Trovata', en: 'Found' },
    reconNotFound: { it: 'Nessuna corrispondenza trovata in Prima Nota', en: 'No match found in Journal Entry' },
    reconStats: { it: '<span class="green">4/5 riconciliate automaticamente</span> \u2014 <span class="amber">1 da verificare manualmente</span>', en: '<span class="green">4/5 automatically reconciled</span> \u2014 <span class="amber">1 to verify manually</span>' },
    f24Title: { it: 'MODELLO F24 \u2014 DELEGA DI PAGAMENTO', en: 'F24 FORM \u2014 PAYMENT ORDER' },
    f24Contribuente: { it: 'Contribuente', en: 'Taxpayer' },
    f24SezioneErario: { it: 'Sezione Erario', en: 'Treasury Section' },
    f24CodFiscale: { it: 'Codice Fiscale', en: 'Tax Code' },
    f24Denominazione: { it: 'Denominazione', en: 'Name' },
    f24Domicilio: { it: 'Domicilio Fiscale', en: 'Tax Domicile' },
    f24CodiceTributo: { it: 'Codice Tributo', en: 'Tax Code' },
    f24Periodo: { it: 'Periodo di Riferimento', en: 'Reference Period' },
    f24ImportoDebito: { it: 'Importo a Debito', en: 'Debit Amount' },
    f24Totale: { it: 'TOTALE', en: 'TOTAL' },
    f24Badge: { it: 'Modello F24 pronto per la revisione', en: 'F24 Form ready for review' },
    f24Cta: { it: 'Vuoi automatizzare le tue fatture?', en: 'Want to automate your invoices?' },
    clickToInspect: { it: 'Clicca sulla segnalazione per i dettagli', en: 'Click the flag for details' }
  };

  function t(key, vars) {
    var s = T[key] ? (T[key][locale] || T[key]['it']) : key;
    if (vars) {
      Object.keys(vars).forEach(function(k) {
        s = s.replace('{' + k + '}', vars[k]);
      });
    }
    return s;
  }

  // ---- DATA ----
  var invoices = [
    { num: '2024/0847', name: 'TechSupply S.r.l.', piva: '02345678901', netto: '\u20AC3.200,00', ivaRate: '22%', iva: '\u20AC704,00', totale: '\u20AC3.904,00', codDest: 'KRRH6B9' },
    { num: '2024/0891', name: 'Studio Legale Bianchi', piva: '01234567890', netto: '\u20AC1.800,00', ivaRate: '22%', iva: '\u20AC396,00', totale: '\u20AC2.196,00', codDest: 'M5UXCR1', extra: ' (Ritenuta d\'acconto 20%)' },
    { num: '2024/0903', name: 'Forniture Ufficio S.p.A.', piva: '03456789012', netto: '\u20AC450,00', ivaRate: '10%', iva: '\u20AC45,00', totale: '\u20AC495,00', codDest: 'J6TN3M4', flagged: true },
    { num: '2024/0912', name: 'Consulenza Marketing', piva: '04567890123', netto: '\u20AC2.500,00', ivaRate: '22%', iva: '\u20AC550,00', totale: '\u20AC3.050,00', codDest: 'A1B2C3D' },
    { num: '2024/0928', name: 'Manutenzione Immobili', piva: '05678901234', netto: '\u20AC1.100,00', ivaRate: '10%', iva: '\u20AC110,00', totale: '\u20AC1.210,00', codDest: 'W9X8Y7Z', noRecon: true }
  ];

  // ---- STATE ----
  var currentStep = 1;

  // ---- INIT ----
  function init() {
    document.getElementById('headerTitle').textContent = t('pageTitle');
    updateProgress();
    buildStep1();
    document.getElementById('btnNext').addEventListener('click', nextStep);
  }

  function updateProgress() {
    document.getElementById('progressLabel').textContent = t('stepOf', { n: currentStep });
    document.getElementById('progressFill').style.width = (currentStep * 25) + '%';
    var btn = document.getElementById('btnNext');
    btn.textContent = t('next');
    btn.disabled = false;
  }

  // ---- STEP 1 ----
  function buildStep1() {
    var queue = document.getElementById('invoiceQueue');
    queue.innerHTML = '';
    invoices.forEach(function(inv, i) {
      var card = document.createElement('div');
      card.className = 'invoice-card';
      var extraText = inv.extra || '';
      card.innerHTML =
        '<div class="inv-number">Fattura n. ' + inv.num + '</div>' +
        '<div class="inv-detail">' + inv.name + ' \u2014 P.IVA: ' + inv.piva +
        ' \u2014 <span class="inv-amount">' + inv.netto + ' + IVA ' + inv.ivaRate + '</span>' +
        extraText + '</div>';
      queue.appendChild(card);
      setTimeout(function() { card.classList.add('visible'); }, 200 + i * 280);
    });
    document.getElementById('queueCounter').textContent = t('queueCounter', { n: 5 });
  }

  // ---- STEP 2 ----
  function buildStep2() {
    // Build table header
    var thead = document.getElementById('extTableHead');
    thead.innerHTML = '<tr><th>#</th><th>' + t('thFornitore') + '</th><th>' + t('thPIVA') +
      '</th><th>' + t('thNetto') + '</th><th>' + t('thIVA') + '</th><th>' + t('thTotale') + '</th></tr>';
    document.getElementById('extTableBody').innerHTML = '';
    document.getElementById('batchCounter').textContent = t('batchCounter', { a: 0, b: 5 });

    var panel = document.getElementById('extractionPanel');
    panel.innerHTML = '';

    // Extraction sequence
    var extractionFields = [
      { label: t('ragioneSociale'), value: invoices[0].name },
      { label: t('piva'), value: invoices[0].piva },
      { label: t('codDestinatario'), value: invoices[0].codDest },
      { label: t('importoNetto'), value: invoices[0].netto },
      { label: t('aliquotaIva'), value: invoices[0].ivaRate },
      { label: t('importoIva'), value: invoices[0].iva },
      { label: t('totaleFattura'), value: invoices[0].totale }
    ];

    // Build expanded invoice view
    var expanded = document.createElement('div');
    expanded.className = 'expanded-invoice';
    expanded.innerHTML = '<div class="scanner-line" id="scannerLine"></div>' +
      '<div style="font-weight:700;font-size:0.95rem;margin-bottom:12px;">Fattura n. ' + invoices[0].num + ' \u2014 ' + invoices[0].name + '</div>';

    extractionFields.forEach(function(f, i) {
      var row = document.createElement('div');
      row.className = 'field-row';
      row.id = 'field-' + i;
      row.innerHTML = '<span class="field-label">' + f.label + '</span>' +
        '<span><span class="field-value">' + f.value + '</span><span class="field-check">\u2713</span></span>';
      expanded.appendChild(row);
    });
    panel.appendChild(expanded);

    // Hint for interactive moment
    var hint = document.createElement('div');
    hint.id = 'interactiveHint';
    hint.style.cssText = 'text-align:center;font-size:0.8rem;color:var(--accent-amber);font-weight:600;margin-top:8px;opacity:0;transition:opacity 0.5s;';
    hint.textContent = t('clickToInspect');
    panel.appendChild(hint);

    // Start scanning animation
    setTimeout(function() {
      document.getElementById('scannerLine').classList.add('scanning');
    }, 300);

    // Extract fields one by one
    extractionFields.forEach(function(f, i) {
      setTimeout(function() {
        var row = document.getElementById('field-' + i);
        if (row) row.classList.add('extracted');
      }, 800 + i * 350);
    });

    // After first invoice extraction, add table row
    var firstDone = 800 + extractionFields.length * 350 + 400;
    setTimeout(function() {
      addTableRow(invoices[0], 1);
      document.getElementById('batchCounter').textContent = t('batchCounter', { a: 1, b: 5 });
    }, firstDone);

    // Process invoices 2-5 with decreasing delays (batch efficiency)
    var delays = [800, 500, 400, 350];
    var batchDelay = firstDone;
    for (var k = 1; k < 5; k++) {
      batchDelay += delays[k - 1];
      (function(i, bd) {
        setTimeout(function() {
          addTableRow(invoices[i], i + 1);
          document.getElementById('batchCounter').textContent = t('batchCounter', { a: i + 1, b: 5 });
          if (i === 2) {
            setTimeout(function() { showAmberFlag(); }, 300);
          }
        }, bd);
      })(k, batchDelay);
    }
  }

  function addTableRow(inv, num) {
    var tbody = document.getElementById('extTableBody');
    var tr = document.createElement('tr');
    tr.className = 'new-row';
    if (inv.flagged) tr.style.background = 'rgba(217,119,6,0.06)';
    tr.innerHTML = '<td>' + num + '</td><td>' + inv.name + '</td><td>' + inv.piva +
      '</td><td>' + inv.netto + '</td><td>' + inv.iva + '</td><td>' + inv.totale + '</td>';
    tbody.appendChild(tr);
  }

  function showAmberFlag() {
    var panel = document.getElementById('extractionPanel');
    // Create flagged invoice card
    var flagCard = document.createElement('div');
    flagCard.className = 'expanded-invoice';
    flagCard.style.position = 'relative';
    flagCard.style.cursor = 'pointer';
    flagCard.innerHTML =
      '<div class="amber-flag" id="amberBtn">\u26A0</div>' +
      '<div style="font-weight:700;font-size:0.9rem;">Fattura n. ' + invoices[2].num + ' \u2014 ' + invoices[2].name + '</div>' +
      '<div style="font-size:0.82rem;color:var(--navy-muted);margin-top:4px;">' + invoices[2].netto + ' + IVA ' + invoices[2].ivaRate + '</div>' +
      '<div class="flag-detail" id="flagDetail">' +
        '<div class="flag-detail-title">' + t('flagTitle') + '</div>' +
        '<p>' + t('flagBody1') + '</p>' +
        '<p>' + t('flagBody2') + '</p>' +
        '<p class="diff">' + t('flagBody3') + '</p>' +
      '</div>';
    panel.appendChild(flagCard);

    var hintEl = document.getElementById('interactiveHint');
    if (hintEl) hintEl.style.opacity = '1';

    flagCard.addEventListener('click', function() {
      var detail = document.getElementById('flagDetail');
      detail.classList.toggle('open');
      var hintEl2 = document.getElementById('interactiveHint');
      if (hintEl2) hintEl2.style.opacity = '0';
    });
  }

  // ---- STEP 3 ----
  function buildStep3() {
    var thead = document.getElementById('reconHead');
    thead.innerHTML = '<tr><th>' + t('reconFattura') + '</th><th>' + t('reconFornitore') +
      '</th><th>' + t('reconImporto') + '</th><th>' + t('reconPrimaNota') + '</th><th>' + t('reconStato') + '</th></tr>';

    var tbody = document.getElementById('reconBody');
    tbody.innerHTML = '';

    var primaNotaRefs = ['PN-2024/1201', 'PN-2024/1203', 'PN-2024/1207', 'PN-2024/1210', '\u2014'];

    invoices.forEach(function(inv, i) {
      var tr = document.createElement('tr');
      tr.id = 'recon-row-' + i;
      tr.style.opacity = '0';
      tr.style.transition = 'opacity 0.4s';
      var isMatch = !inv.noRecon;
      tr.innerHTML = '<td>n. ' + inv.num + '</td><td>' + inv.name + '</td><td>' + inv.totale +
        '</td><td>' + primaNotaRefs[i] + '</td>' +
        '<td class="match-cell"><span id="match-icon-' + i + '"></span></td>';
      tbody.appendChild(tr);
    });

    // Animate rows appearing
    invoices.forEach(function(inv, i) {
      setTimeout(function() {
        var row = document.getElementById('recon-row-' + i);
        if (row) row.style.opacity = '1';
      }, 300 + i * 300);
    });

    // Animate match icons
    invoices.forEach(function(inv, i) {
      setTimeout(function() {
        var icon = document.getElementById('match-icon-' + i);
        if (icon) {
          if (inv.noRecon) {
            icon.className = 'match-fail';
            icon.textContent = '\u2717';
            icon.title = t('reconNotFound');
          } else {
            icon.className = 'match-ok';
            icon.textContent = '\u2713';
          }
        }
      }, 800 + i * 400);
    });

    // Show stats
    setTimeout(function() {
      document.getElementById('reconStats').innerHTML = t('reconStats');
    }, 800 + 5 * 400);
  }

  // ---- STEP 4 ----
  function buildStep4() {
    document.getElementById('f24Header').textContent = t('f24Title');

    // Contribuente section
    document.getElementById('f24ContribTitle').textContent = t('f24Contribuente');
    document.getElementById('f24ContribBody').innerHTML =
      '<div class="f24-row"><span class="f24-label">' + t('f24CodFiscale') + '</span><span class="f24-value" id="f24cf"></span></div>' +
      '<div class="f24-row"><span class="f24-label">' + t('f24Denominazione') + '</span><span class="f24-value" id="f24denom"></span></div>' +
      '<div class="f24-row"><span class="f24-label">' + t('f24Domicilio') + '</span><span class="f24-value" id="f24dom"></span></div>';

    // Erario section
    document.getElementById('f24ErarioTitle').textContent = t('f24SezioneErario');
    document.getElementById('f24ErarioBody').innerHTML =
      '<div class="f24-row"><span class="f24-label">' + t('f24CodiceTributo') + '</span><span class="f24-value" id="f24trib"></span></div>' +
      '<div class="f24-row"><span class="f24-label">' + t('f24Periodo') + '</span><span class="f24-value" id="f24per"></span></div>' +
      '<div class="f24-row"><span class="f24-label">' + t('f24ImportoDebito') + '</span><span class="f24-value" id="f24imp"></span></div>';

    // Totale
    document.getElementById('f24Total').innerHTML =
      '<span>' + t('f24Totale') + '</span><span id="f24tot"></span>';

    // Badge
    document.getElementById('f24Badge').innerHTML =
      '<div class="f24-badge-inner">\u2713 ' + t('f24Badge') + '</div>';

    // CTA (sandbox-safe: no navigation)
    var ctaEl = document.getElementById('f24Cta');
    var ctaButton = document.createElement('button');
    ctaButton.style.cssText = 'display:inline-block;background:var(--navy);color:var(--white);font-weight:600;font-size:0.88rem;padding:12px 28px;border-radius:8px;border:none;cursor:pointer;transition:background 0.2s;font-family:var(--font-body)';
    ctaButton.textContent = t('f24Cta');
    ctaButton.addEventListener('mouseenter', function() { ctaButton.style.background = 'var(--navy-light)'; });
    ctaButton.addEventListener('mouseleave', function() { if (!ctaButton.disabled) ctaButton.style.background = 'var(--navy)'; });
    ctaButton.addEventListener('click', function(e) {
      e.preventDefault();
      ctaButton.style.background = 'var(--accent-green)';
      ctaButton.textContent = '\u2713 ' + (locale === 'en' ? 'Demo completed' : 'Demo terminata');
      ctaButton.style.cursor = 'default';
      ctaButton.disabled = true;
    });
    ctaEl.innerHTML = '';
    ctaEl.appendChild(ctaButton);

    // Animate sections
    setTimeout(function() {
      document.getElementById('f24Contrib').classList.add('visible');
      fillField('f24cf', 'RSSMRA80A01H501Z', 300);
      fillField('f24denom', 'Studio Rossi & Associati', 600);
      fillField('f24dom', 'Via Roma 42, 00100 Roma (RM)', 900);
    }, 400);

    setTimeout(function() {
      document.getElementById('f24Erario').classList.add('visible');
      fillField('f24trib', '6001 (Versamento IVA mensile)', 300);
      fillField('f24per', '01/2026', 600);
      fillField('f24imp', '\u20AC1.684,00', 900);
    }, 1800);

    setTimeout(function() {
      document.getElementById('f24tot').textContent = '\u20AC1.684,00';
      document.getElementById('f24tot').classList.add('filling');
    }, 3200);

    setTimeout(function() {
      document.getElementById('f24Badge').classList.add('visible');
    }, 3800);

    setTimeout(function() {
      document.getElementById('f24Cta').classList.add('visible');
    }, 4300);
  }

  function fillField(id, value, delay) {
    setTimeout(function() {
      var el = document.getElementById(id);
      if (el) {
        el.textContent = value;
        el.classList.add('filling');
      }
    }, delay);
  }

  // ---- NAVIGATION ----
  function nextStep() {
    if (currentStep >= 4) return;

    // Hide current step
    document.getElementById('step' + currentStep).classList.remove('active');
    currentStep++;
    document.getElementById('step' + currentStep).classList.add('active');
    updateProgress();

    if (currentStep === 2) buildStep2();
    else if (currentStep === 3) buildStep3();
    else if (currentStep === 4) {
      buildStep4();
      document.getElementById('btnNext').disabled = true;
    }
  }

  // ---- START ----
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

})();
</script>
</body>
</html>
