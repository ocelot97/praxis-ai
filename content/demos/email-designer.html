<!DOCTYPE html>
<html lang="it" id="htmlRoot">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Automazione Pratiche Catastali â€” Praxis AI</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Caveat:wght@700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --navy:#0f172a;--navy-light:#1e3a5f;--navy-muted:#334155;
  --silver:#94a3b8;--surface:#f0f4f8;--surface-light:#f8fafc;
  --surface-dark:#e2e8f0;--ice:#fafbfd;--border:#cbd5e1;
  --white:#ffffff;--accent-green:#16a34a;--accent-amber:#d97706;--accent-red:#dc2626;
  --font-body:'Inter',system-ui,sans-serif;--font-display:'Caveat',cursive;
}
html{font-size:16px}
body{font-family:var(--font-body);background:var(--surface);color:var(--navy);min-height:100vh;display:flex;flex-direction:column;-webkit-font-smoothing:antialiased;overflow-x:hidden}

/* Header */
.header{display:flex;align-items:center;justify-content:space-between;padding:14px 28px;background:var(--navy);color:var(--white);flex-shrink:0}
.header-left{display:flex;align-items:center;gap:16px}
.header-logo{font-family:var(--font-display);font-size:26px;font-weight:700;color:var(--white)}
.header-divider{width:1px;height:24px;background:var(--navy-muted)}
.header-title{font-size:14px;font-weight:500;color:var(--silver)}
.header-badge{background:var(--accent-amber);color:var(--white);font-size:10px;font-weight:700;padding:3px 10px;border-radius:20px;letter-spacing:1px;text-transform:uppercase}

/* Progress */
.progress-bar{padding:0 28px;background:var(--white);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:16px;height:44px;flex-shrink:0}
.progress-label{font-size:12px;font-weight:600;color:var(--navy-muted);white-space:nowrap}
.progress-track{flex:1;height:6px;background:var(--surface-dark);border-radius:3px;overflow:hidden}
.progress-fill{height:100%;width:25%;background:linear-gradient(90deg,var(--navy-light),var(--navy));border-radius:3px;transition:width .5s ease}
.progress-step{font-size:12px;font-weight:600;color:var(--navy);white-space:nowrap}

/* Main */
.main{flex:1;display:flex;flex-direction:column;padding:24px 28px 28px;gap:20px;overflow-y:auto}

/* Step container */
.step-container{display:none;flex-direction:column;gap:16px;animation:fadeInUp .4s ease forwards}
.step-container.active{display:flex}
@keyframes fadeInUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}

/* Card */
.card{background:var(--white);border:1px solid var(--border);border-radius:12px;overflow:hidden}
.card-header{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--ice)}
.card-header h3{font-size:14px;font-weight:700;color:var(--navy);display:flex;align-items:center;gap:8px}
.card-header .tag{font-size:10px;font-weight:600;padding:2px 8px;border-radius:12px;background:var(--surface-dark);color:var(--navy-muted)}
.card-body{padding:16px 20px}

/* Data table */
.data-table{width:100%;border-collapse:collapse;font-size:12px}
.data-table th{text-align:left;padding:8px 10px;background:var(--surface);font-weight:600;color:var(--navy-muted);font-size:10px;text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid var(--border)}
.data-table td{padding:8px 10px;border-bottom:1px solid var(--surface-dark);font-variant-numeric:tabular-nums}
.data-table tr.highlight td{background:rgba(22,163,74,.06)}
.data-table tr{opacity:0;transform:translateX(-8px);transition:all .3s ease}
.data-table tr.visible{opacity:1;transform:translateX(0)}

/* SVG map */
.svg-map{width:100%;height:220px;background:var(--surface);border-radius:8px;border:1px solid var(--border);overflow:hidden}

/* Stats row */
.stats-row{display:flex;gap:10px;flex-wrap:wrap}
.stat-chip{display:flex;align-items:center;gap:6px;padding:6px 14px;border-radius:20px;font-size:12px;font-weight:600;background:var(--surface);color:var(--navy)}
.stat-chip .dot{width:8px;height:8px;border-radius:50%}

/* DOCFA form */
.docfa-form{display:flex;flex-direction:column;gap:0}
.docfa-row{display:flex;align-items:center;padding:10px 16px;border-bottom:1px solid var(--surface-dark);gap:12px;min-height:44px}
.docfa-label{width:180px;font-size:12px;font-weight:600;color:var(--navy-muted);text-transform:uppercase;letter-spacing:.3px;flex-shrink:0}
.docfa-value{flex:1;font-size:14px;font-weight:500;color:var(--navy);min-height:20px;position:relative}
.docfa-value .cursor{display:inline-block;width:2px;height:16px;background:var(--navy);animation:blink .6s infinite;vertical-align:text-bottom;margin-left:1px}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}
.docfa-check{width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0;opacity:0;transform:scale(.5);transition:all .3s cubic-bezier(.34,1.56,.64,1)}
.docfa-check.done{opacity:1;transform:scale(1);background:#dcfce7;color:var(--accent-green)}
.docfa-check.warn{opacity:1;transform:scale(1);background:#fef3c7;color:var(--accent-amber)}

/* Validation panel */
.val-panel{padding:12px 16px;background:var(--surface);border-radius:8px;font-size:12px;color:var(--navy-muted)}
.val-panel .val-count{font-size:20px;font-weight:700;color:var(--navy)}

/* Interactive warning */
.rendita-warning{border:2px solid var(--accent-amber);border-radius:10px;padding:14px 18px;background:#fffbeb;cursor:pointer;transition:all .3s ease;position:relative;overflow:hidden;max-height:60px}
.rendita-warning.expanded{max-height:500px;cursor:default}
.rendita-warning .pulse-ring{position:absolute;top:8px;right:8px;width:12px;height:12px;border-radius:50%;background:var(--accent-amber);animation:pulse 1.5s ease infinite}
.rendita-warning.expanded .pulse-ring{display:none}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(217,119,6,.5)}70%{box-shadow:0 0 0 10px rgba(217,119,6,0)}100%{box-shadow:0 0 0 0 rgba(217,119,6,0)}}
.rendita-summary{font-size:13px;font-weight:600;color:var(--accent-amber);display:flex;align-items:center;gap:8px}
.rendita-detail{margin-top:14px;padding-top:14px;border-top:1px solid #fde68a;font-size:13px;line-height:1.7;color:var(--navy);opacity:0;transform:translateY(-8px);transition:all .3s ease .1s}
.rendita-warning.expanded .rendita-detail{opacity:1;transform:translateY(0)}
.rendita-detail .warn-value{font-weight:700;color:var(--accent-amber)}
.rendita-detail .cause-list{margin:8px 0 8px 20px;list-style:decimal}
.rendita-detail .cause-list li{margin-bottom:4px}
.rendita-detail .suggestion{margin-top:10px;padding:10px 14px;background:var(--white);border-radius:6px;border-left:3px solid var(--accent-amber);font-size:12px;font-weight:500}

/* Split view */
.split-view{display:flex;gap:16px;min-height:360px}
.split-view .split-left,.split-view .split-right{flex:1;min-width:0}

/* PREGEO data */
.pregeo-row{display:flex;gap:8px;padding:6px 0;border-bottom:1px solid var(--surface-dark);font-size:12px}
.pregeo-label{width:160px;font-weight:600;color:var(--navy-muted);flex-shrink:0}
.pregeo-value{flex:1;color:var(--navy);font-weight:500}

/* Submission items */
.submission-item{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid var(--surface-dark);font-size:13px;font-weight:500;opacity:0;transform:translateX(-12px);transition:all .4s ease}
.submission-item.visible{opacity:1;transform:translateX(0)}
.submission-item .si-icon{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.submission-item .si-icon.green{background:#dcfce7;color:var(--accent-green)}
.submission-item .si-icon.amber{background:#fef3c7;color:var(--accent-amber)}

/* Status badge */
.status-badge{display:flex;align-items:center;gap:10px;padding:16px 20px;background:linear-gradient(135deg,var(--navy),var(--navy-light));border-radius:10px;color:var(--white);font-size:14px;font-weight:600}
.status-badge .sb-dot{width:10px;height:10px;border-radius:50%;background:var(--accent-green);animation:pulse 2s ease infinite}

/* CTA */
.cta-section{text-align:center;padding:20px 0 8px}
.cta-title{font-family:var(--font-display);font-size:28px;font-weight:700;color:var(--navy);margin-bottom:4px}
.cta-sub{font-size:14px;color:var(--silver);margin-bottom:16px}
.cta-btn{display:inline-flex;align-items:center;gap:8px;padding:12px 32px;background:var(--navy);color:var(--white);border:none;border-radius:8px;font-family:var(--font-body);font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;box-shadow:0 4px 16px rgba(15,23,42,.25)}
.cta-btn:hover{background:var(--navy-light);transform:translateY(-1px);box-shadow:0 6px 24px rgba(15,23,42,.35)}

/* Next button */
.btn-row{display:flex;justify-content:flex-end;padding-top:4px;flex-shrink:0}
.next-btn{display:inline-flex;align-items:center;gap:8px;padding:10px 28px;background:var(--navy);color:var(--white);border:none;border-radius:8px;font-family:var(--font-body);font-size:13px;font-weight:600;cursor:pointer;transition:all .2s}
.next-btn:hover{background:var(--navy-light);transform:translateY(-1px)}
.next-btn:disabled{opacity:.4;cursor:not-allowed;transform:none}

/* Responsive */
@media(max-width:768px){
  .header{padding:12px 16px;flex-wrap:wrap;gap:8px}
  .main{padding:16px}
  .split-view{flex-direction:column}
  .docfa-label{width:120px;font-size:11px}
  .header-title{display:none}
}

/* Scrollbar */
::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--silver);border-radius:10px}
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-left">
    <span class="header-logo">Praxis AI</span>
    <div class="header-divider"></div>
    <span class="header-title" data-i18n="headerTitle"></span>
  </div>
  <span class="header-badge">DEMO</span>
</div>

<!-- Progress -->
<div class="progress-bar">
  <span class="progress-label" data-i18n="progressLabel"></span>
  <div class="progress-track"><div class="progress-fill" id="progressFill"></div></div>
  <span class="progress-step" id="progressStep"></span>
</div>

<!-- Main Content -->
<div class="main" id="mainContent">

  <!-- Step 1: Survey Data Import -->
  <div class="step-container active" id="step1">
    <div class="card">
      <div class="card-header">
        <h3 data-i18n="step1Title"></h3>
        <span class="tag" data-i18n="step1Tag"></span>
      </div>
      <div class="card-body" style="padding:0">
        <div style="padding:12px 20px;background:var(--surface);border-bottom:1px solid var(--border);font-size:12px;font-weight:600;color:var(--navy-muted)" data-i18n="surveyHeader"></div>
        <div style="overflow-x:auto">
          <table class="data-table" id="surveyTable">
            <thead><tr class="visible"><th data-i18n="thPoint"></th><th data-i18n="thNorth"></th><th data-i18n="thEast"></th><th data-i18n="thQuota"></th><th data-i18n="thDist"></th><th data-i18n="thAngle"></th></tr></thead>
            <tbody id="surveyBody"></tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-header">
        <h3 data-i18n="mapTitle"></h3>
        <span class="tag" data-i18n="mapTag"></span>
      </div>
      <div class="card-body">
        <div class="svg-map" id="svgMapContainer"></div>
        <div class="stats-row" style="margin-top:12px">
          <div class="stat-chip"><span class="dot" style="background:var(--accent-green)"></span><span data-i18n="statPoints"></span></div>
          <div class="stat-chip"><span class="dot" style="background:var(--navy)"></span><span data-i18n="statArea"></span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Step 2: DOCFA Compilation -->
  <div class="step-container" id="step2">
    <div class="card">
      <div class="card-header">
        <h3 data-i18n="step2Title"></h3>
        <span class="tag">DOCFA 4.0</span>
      </div>
      <div class="card-body" style="padding:0">
        <div class="docfa-form" id="docfaForm"></div>
      </div>
    </div>
    <div style="display:flex;gap:16px;flex-wrap:wrap">
      <div class="card" style="flex:1;min-width:200px">
        <div class="card-header"><h3 data-i18n="validationTitle"></h3></div>
        <div class="card-body">
          <div class="val-panel" id="valPanel">
            <div class="val-count" id="valCount">0/9</div>
            <div data-i18n="valLabel" style="margin-top:2px"></div>
            <div style="margin-top:8px;height:4px;background:var(--border);border-radius:2px;overflow:hidden">
              <div id="valBar" style="height:100%;width:0%;background:var(--accent-green);border-radius:2px;transition:width .4s ease"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="card" style="flex:2;min-width:280px" id="warningCard" style="display:none">
        <div class="card-header"><h3 data-i18n="alertTitle"></h3></div>
        <div class="card-body">
          <div class="rendita-warning" id="renditaWarning" style="display:none">
            <div class="pulse-ring"></div>
            <div class="rendita-summary" data-i18n="renditaSummary"></div>
            <div class="rendita-detail" id="renditaDetail"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Step 3: PREGEO Elaboration -->
  <div class="step-container" id="step3">
    <div class="split-view">
      <div class="split-left">
        <div class="card" style="height:100%">
          <div class="card-header">
            <h3 data-i18n="step3LeftTitle"></h3>
            <span class="tag">PREGEO 10</span>
          </div>
          <div class="card-body" id="pregeoData"></div>
        </div>
      </div>
      <div class="split-right">
        <div class="card" style="height:100%">
          <div class="card-header">
            <h3 data-i18n="step3RightTitle"></h3>
            <span class="tag" data-i18n="mapTag"></span>
          </div>
          <div class="card-body" style="padding:0">
            <div class="svg-map" id="pregeoMap" style="height:100%;min-height:320px;border-radius:0"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Step 4: Submission Preview -->
  <div class="step-container" id="step4">
    <div class="card">
      <div class="card-header"><h3 data-i18n="step4PackageTitle"></h3></div>
      <div class="card-body" style="padding:0">
        <div id="packageList"></div>
      </div>
    </div>
    <div class="card">
      <div class="card-header"><h3 data-i18n="step4CheckTitle"></h3></div>
      <div class="card-body" style="padding:0">
        <div id="checkList"></div>
      </div>
    </div>
    <div class="status-badge" id="statusBadge" style="opacity:0;transition:opacity .5s ease">
      <span class="sb-dot"></span>
      <span data-i18n="statusReady"></span>
    </div>
    <div class="cta-section" id="ctaSection" style="opacity:0;transition:opacity .5s ease .3s">
      <div class="cta-title" data-i18n="ctaTitle"></div>
      <div class="cta-sub" data-i18n="ctaSub"></div>
      <button class="cta-btn" data-i18n="ctaBtn"></button>
    </div>
  </div>

</div>

<!-- Next Button -->
<div class="btn-row" style="padding:0 28px 16px">
  <button class="next-btn" id="nextBtn" disabled>
    <span id="nextBtnLabel"></span>
    <span>&#8594;</span>
  </button>
</div>

<script>
(function(){
"use strict";

var LOCALE=(typeof window!=='undefined'&&window.__PRAXIS_LOCALE__)||'it';

var T={
  headerTitle:{en:'Cadastral Procedures Automation',it:'Automazione Pratiche Catastali'},
  progressLabel:{en:'Progress',it:'Avanzamento'},
  step1Title:{en:'Topographic Survey Import',it:'Importazione Rilievo Topografico'},
  step1Tag:{en:'Imported data',it:'Dati importati'},
  surveyHeader:{en:'Survey n. 2026/014 \u2014 Municipality of Brescia \u2014 Sheet 12, Parcel 345',it:'Rilievo n. 2026/014 \u2014 Comune di Brescia \u2014 Foglio 12, Particella 345'},
  thPoint:{en:'Point',it:'Punto'},
  thNorth:{en:'North (m)',it:'Nord (m)'},
  thEast:{en:'East (m)',it:'Est (m)'},
  thQuota:{en:'Elevation (m)',it:'Quota (m)'},
  thDist:{en:'Dist. (m)',it:'Dist. (m)'},
  thAngle:{en:'Angle',it:'Angolo'},
  mapTitle:{en:'Survey Map',it:'Mappa Rilievo'},
  mapTag:{en:'SVG View',it:'Vista SVG'},
  statPoints:{en:'8 surveyed points',it:'8 punti rilevati'},
  statArea:{en:'Approx. area 1,247 sqm',it:'Superficie appross. 1.247 mq'},
  step2Title:{en:'DOCFA Form Compilation',it:'Compilazione Modello DOCFA'},
  validationTitle:{en:'Validation',it:'Validazione'},
  valLabel:{en:'fields validated',it:'campi validati'},
  alertTitle:{en:'AI Alerts',it:'Alert AI'},
  renditaSummary:{en:'\u26A0 Cadastral Income Above Zone Average',it:'\u26A0 Rendita Catastale Superiore alla Media di Zona'},
  step3LeftTitle:{en:'Technical Data',it:'Dati Tecnici'},
  step3RightTitle:{en:'Cadastral Map',it:'Mappa Catastale'},
  step4PackageTitle:{en:'Submission Package',it:'Fascicolo per l\'Invio'},
  step4CheckTitle:{en:'Final Validation',it:'Validazione Finale'},
  statusReady:{en:'File ready for submission to the Land Registry Agency',it:'Pratica pronta per l\'invio all\'Agenzia del Territorio'},
  ctaTitle:{en:'Automate your cadastral procedures',it:'Vuoi automatizzare le tue pratiche catastali?'},
  ctaSub:{en:'Discover how Praxis AI can help your surveying practice',it:'Scopri come Praxis AI puo\u0300 aiutare il tuo studio di geometra'},
  ctaBtn:{en:'Request a Demo',it:'Richiedi una Demo'},
  nextBtn:{en:'Next',it:'Avanti'},
  stepOf:{en:'Step {n} of 4',it:'Passo {n} di 4'},
  clickToExpand:{en:'Click to see details',it:'Clicca per vedere i dettagli'},
  renditaProposed:{en:'Proposed income:',it:'Rendita proposta:'},
  renditaAvg:{en:'Zone average for category A/2, class 3:',it:'Media zona per categoria A/2, classe 3:'},
  renditaDev:{en:'Deviation:',it:'Scostamento:'},
  renditaCauses:{en:'Possible causes:',it:'Possibili cause:'},
  renditaCause1:{en:'Declared consistency (6.5 rooms) higher than zone average (5.0 rooms)',it:'Consistenza dichiarata (6.5 vani) superiore alla media zona (5.0 vani)'},
  renditaCause2:{en:'Check if accessory surface (balconies, cellars) was correctly included',it:'Verificare se la superficie accessoria (balconi, cantine) \u00E8 stata inclusa correttamente'},
  renditaSuggestion:{en:'Suggestion: Re-evaluate the room count of accessory spaces before submission',it:'Suggerimento: Rivalutare il computo dei vani accessori prima dell\'invio'},
  pregeoTipo:{en:'Map type:',it:'Tipo mappale:'},
  pregeoTipoVal:{en:'Subdivision',it:'Frazionamento'},
  pregeoSistema:{en:'Reference system:',it:'Sistema di riferimento:'},
  pregeoSistemaVal:{en:'Gauss-Boaga \u2014 East Zone',it:'Gauss-Boaga \u2014 Fuso Est'},
  pregeoCoord:{en:'Converted coordinates',it:'Coordinate convertite'},
  pregeoSup:{en:'Computed area:',it:'Superficie computata:'},
  pregeoSupVal:{en:'1,247.32 sqm',it:'1.247,32 mq'},
  pregeoPrecision:{en:'Precision:',it:'Precisione:'},
  pregeoPrecisionVal:{en:'\u00B10.08 sqm',it:'\u00B10,08 mq'},
  pkgDocfa:{en:'DOCFA Form \u2014 Compiled and validated',it:'Modello DOCFA \u2014 Compilato e validato'},
  pkgPregeo:{en:'PREGEO Elaboration \u2014 Calculations verified',it:'Elaborato PREGEO \u2014 Calcoli verificati'},
  pkgPlan:{en:'Cadastral floor plan \u2014 Generated from survey',it:'Planimetria catastale \u2014 Generata da rilievo'},
  pkgReport:{en:'Technical report \u2014 Automatically compiled',it:'Relazione tecnica \u2014 Compilata automaticamente'},
  chkFormat:{en:'File format: compliant',it:'Formato file: conforme'},
  chkCoherence:{en:'DOCFA-PREGEO data coherence: verified',it:'Coerenza dati DOCFA-PREGEO: verificata'},
  chkSurface:{en:'Declared vs. calculated area: matching (\u0394 < 0.5%)',it:'Superficie dichiarata vs calcolata: corrispondente (\u0394 < 0,5%)'},
  chkSignature:{en:'Digital signature: pending',it:'Firma digitale: in attesa'}
};

function t(k){var e=T[k];return e?(e[LOCALE]||e.it||k):k}
function applyI18n(){
  document.getElementById('htmlRoot').setAttribute('lang',LOCALE);
  var els=document.querySelectorAll('[data-i18n]');
  for(var i=0;i<els.length;i++){var k=els[i].getAttribute('data-i18n');if(T[k])els[i].textContent=t(k)}
}

/* Survey data */
var surveyPoints=[
  {id:'P1',n:5045123.45,e:1598234.67,q:125.3,dist:42.15,angle:'87\u00B032\'14"'},
  {id:'P2',n:5045156.78,e:1598267.89,q:125.8,dist:38.92,angle:'91\u00B018\'45"'},
  {id:'P3',n:5045189.01,e:1598245.12,q:126.1,dist:35.67,angle:'88\u00B004\'22"'},
  {id:'P4',n:5045167.34,e:1598212.45,q:125.5,dist:28.43,angle:'93\u00B041\'08"'},
  {id:'P5',n:5045145.23,e:1598198.34,q:125.1,dist:31.56,angle:'86\u00B055\'33"'},
  {id:'P6',n:5045132.67,e:1598221.78,q:125.4,dist:26.89,angle:'90\u00B012\'17"'},
  {id:'P7',n:5045118.90,e:1598248.56,q:125.2,dist:33.24,angle:'92\u00B027\'41"'},
  {id:'P8',n:5045110.12,e:1598230.23,q:125.0,dist:29.78,angle:'89\u00B008\'56"'}
];

var docfaFields=[
  {label:'Sezione',value:'BRESCIA'},
  {label:'Foglio',value:'12'},
  {label:'Particella',value:'345'},
  {label:'Subalterno',value:'2'},
  {label:'Categoria',value:'A/2 \u2014 Abitazioni di tipo civile'},
  {label:'Classe',value:'3'},
  {label:'Consistenza',value:'6,5 vani'},
  {label:'Superficie catastale',value:'115 mq'},
  {label:'Rendita catastale proposta',value:'\u20AC1.245,00',warn:true}
];

var currentStep=1;
var stepReady=false;

function $(id){return document.getElementById(id)}

/* Update progress bar */
function updateProgress(){
  var pct=currentStep*25;
  $('progressFill').style.width=pct+'%';
  $('progressStep').textContent=t('stepOf').replace('{n}',currentStep);
  $('nextBtnLabel').textContent=currentStep<4?t('nextBtn'):'';
  $('nextBtn').style.display=currentStep>=4?'none':'';
}

/* Show step */
function showStep(n){
  for(var i=1;i<=4;i++){
    var el=$('step'+i);
    if(el)el.classList.toggle('active',i===n);
  }
  currentStep=n;
  stepReady=false;
  $('nextBtn').disabled=true;
  updateProgress();
  if(n===1)animateStep1();
  else if(n===2)animateStep2();
  else if(n===3)animateStep3();
  else if(n===4)animateStep4();
}

function enableNext(){
  stepReady=true;
  $('nextBtn').disabled=false;
}

$('nextBtn').addEventListener('click',function(){
  if(stepReady&&currentStep<4){
    showStep(currentStep+1);
  }
});

/* ============ STEP 1 ============ */
function animateStep1(){
  var tbody=$('surveyBody');
  tbody.innerHTML='';
  surveyPoints.forEach(function(p,i){
    var tr=document.createElement('tr');
    tr.innerHTML='<td><strong>'+p.id+'</strong></td><td>'+p.n.toFixed(2)+'</td><td>'+p.e.toFixed(2)+'</td><td>'+p.q.toFixed(1)+'</td><td>'+p.dist.toFixed(2)+'</td><td>'+p.angle+'</td>';
    tbody.appendChild(tr);
    setTimeout(function(){tr.classList.add('visible')},150+i*120);
  });

  /* SVG map */
  setTimeout(function(){drawSurveyMap()},400);
  setTimeout(enableNext,150+surveyPoints.length*120+400);
}

function drawSurveyMap(){
  var container=$('svgMapContainer');
  /* Normalize points for SVG drawing */
  var minN=Infinity,maxN=-Infinity,minE=Infinity,maxE=-Infinity;
  surveyPoints.forEach(function(p){
    if(p.n<minN)minN=p.n;if(p.n>maxN)maxN=p.n;
    if(p.e<minE)minE=p.e;if(p.e>maxE)maxE=p.e;
  });
  var rangeN=maxN-minN||1,rangeE=maxE-minE||1;
  var pad=30,w=container.clientWidth||500,h=container.clientHeight||220;
  var scale=Math.min((w-2*pad)/rangeE,(h-2*pad)/rangeN);

  var pts=surveyPoints.map(function(p){
    return{x:pad+(p.e-minE)*scale,y:h-pad-(p.n-minN)*scale,id:p.id};
  });

  var polyStr=pts.map(function(p){return p.x+','+p.y}).join(' ');

  var svg='<svg width="'+w+'" height="'+h+'" xmlns="http://www.w3.org/2000/svg" style="font-family:var(--font-body)">';
  /* Grid lines */
  for(var gx=0;gx<w;gx+=40)svg+='<line x1="'+gx+'" y1="0" x2="'+gx+'" y2="'+h+'" stroke="var(--border)" stroke-width="0.5" stroke-dasharray="2,4"/>';
  for(var gy=0;gy<h;gy+=40)svg+='<line x1="0" y1="'+gy+'" x2="'+w+'" y2="'+gy+'" stroke="var(--border)" stroke-width="0.5" stroke-dasharray="2,4"/>';
  /* Polygon fill */
  svg+='<polygon points="'+polyStr+'" fill="rgba(15,23,42,0.06)" stroke="var(--navy)" stroke-width="2" stroke-linejoin="round"><animate attributeName="stroke-dashoffset" from="800" to="0" dur="1.5s" fill="freeze"/></polygon>';
  /* Boundary lines with distances */
  for(var i=0;i<pts.length;i++){
    var j=(i+1)%pts.length;
    var mx=(pts[i].x+pts[j].x)/2,my=(pts[i].y+pts[j].y)/2;
    svg+='<line x1="'+pts[i].x+'" y1="'+pts[i].y+'" x2="'+pts[j].x+'" y2="'+pts[j].y+'" stroke="var(--navy)" stroke-width="1.5" opacity="0"><animate attributeName="opacity" from="0" to="1" begin="'+(i*0.15)+'s" dur="0.3s" fill="freeze"/></line>';
    svg+='<text x="'+mx+'" y="'+(my-6)+'" text-anchor="middle" fill="var(--navy-muted)" font-size="9" font-weight="600" opacity="0"><animate attributeName="opacity" from="0" to="1" begin="'+(i*0.15+0.2)+'s" dur="0.3s" fill="freeze"/>'+surveyPoints[i].dist.toFixed(1)+'m</text>';
  }
  /* Points */
  pts.forEach(function(p,i){
    svg+='<circle cx="'+p.x+'" cy="'+p.y+'" r="5" fill="var(--navy)" opacity="0"><animate attributeName="opacity" from="0" to="1" begin="'+(i*0.12)+'s" dur="0.3s" fill="freeze"/><animate attributeName="r" from="0" to="5" begin="'+(i*0.12)+'s" dur="0.3s" fill="freeze"/></circle>';
    svg+='<text x="'+(p.x+10)+'" y="'+(p.y-8)+'" fill="var(--navy)" font-size="10" font-weight="700" opacity="0"><animate attributeName="opacity" from="0" to="1" begin="'+(i*0.12+0.1)+'s" dur="0.2s" fill="freeze"/>'+p.id+'</text>';
  });
  /* North arrow */
  svg+='<g transform="translate('+(w-35)+',30)"><polygon points="0,-15 -5,0 5,0" fill="var(--navy)"/><text x="0" y="12" text-anchor="middle" fill="var(--navy)" font-size="10" font-weight="700">N</text></g>';
  svg+='</svg>';
  container.innerHTML=svg;
}

/* ============ STEP 2 ============ */
function animateStep2(){
  var form=$('docfaForm');
  form.innerHTML='';
  docfaFields.forEach(function(f){
    var row=document.createElement('div');
    row.className='docfa-row';
    row.innerHTML='<div class="docfa-label">'+f.label+'</div><div class="docfa-value" id="docfa_'+f.label.replace(/\s/g,'_')+'"><span class="cursor"></span></div><div class="docfa-check" id="chk_'+f.label.replace(/\s/g,'_')+'"></div>';
    form.appendChild(row);
  });

  var validated=0;
  var total=docfaFields.length;

  docfaFields.forEach(function(f,i){
    setTimeout(function(){typeField(f,i,function(){
      validated++;
      var chk=$('chk_'+f.label.replace(/\s/g,'_'));
      if(f.warn){
        chk.textContent='\u26A0';
        chk.classList.add('warn');
        $('valCount').textContent=(validated-1)+'/'+total;
        $('valBar').style.width=((validated-1)/total*100)+'%';
        /* Show warning */
        var w=$('renditaWarning');
        w.style.display='';
        buildWarningDetail();
        w.addEventListener('click',function handler(){
          w.classList.add('expanded');
          w.removeEventListener('click',handler);
        });
      }else{
        chk.textContent='\u2713';
        chk.classList.add('done');
        $('valCount').textContent=validated+'/'+total;
        $('valBar').style.width=(validated/total*100)+'%';
      }
      if(i===total-1){
        $('valCount').textContent='7/9 \u2014 2 '+t('valLabel').split(' ').slice(-1)[0];
        setTimeout(enableNext,600);
      }
    })},i*800+300);
  });
}

function typeField(field,idx,cb){
  var el=$('docfa_'+field.label.replace(/\s/g,'_'));
  if(!el){if(cb)cb();return;}
  var text=field.value;
  var charIdx=0;
  var span=document.createElement('span');
  el.innerHTML='';
  el.appendChild(span);
  var cursor=document.createElement('span');
  cursor.className='cursor';
  el.appendChild(cursor);

  var interval=setInterval(function(){
    if(charIdx<text.length){
      span.textContent+=text.charAt(charIdx);
      charIdx++;
    }else{
      clearInterval(interval);
      cursor.remove();
      if(cb)cb();
    }
  },35);
}

function buildWarningDetail(){
  var d=$('renditaDetail');
  d.innerHTML='<div style="margin-bottom:6px;font-size:12px;color:var(--silver)">'+t('clickToExpand')+'</div>'+
    '<div><strong>'+t('renditaProposed')+'</strong> <span class="warn-value">\u20AC1.245,00</span></div>'+
    '<div><strong>'+t('renditaAvg')+'</strong> \u20AC1.082,00</div>'+
    '<div><strong>'+t('renditaDev')+'</strong> <span class="warn-value">+15,1%</span></div>'+
    '<div style="margin-top:8px"><strong>'+t('renditaCauses')+'</strong></div>'+
    '<ol class="cause-list"><li>'+t('renditaCause1')+'</li><li>'+t('renditaCause2')+'</li></ol>'+
    '<div class="suggestion">'+t('renditaSuggestion')+'</div>';
}

/* ============ STEP 3 ============ */
function animateStep3(){
  var dataEl=$('pregeoData');
  dataEl.innerHTML='';

  var rows=[
    {l:t('pregeoTipo'),v:t('pregeoTipoVal')},
    {l:t('pregeoSistema'),v:t('pregeoSistemaVal')}
  ];

  var html='';
  rows.forEach(function(r){
    html+='<div class="pregeo-row"><div class="pregeo-label">'+r.l+'</div><div class="pregeo-value">'+r.v+'</div></div>';
  });

  html+='<div style="margin:12px 0 6px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--navy-muted)">'+t('pregeoCoord')+'</div>';
  html+='<table class="data-table" style="margin-bottom:12px"><thead><tr class="visible"><th>'+t('thPoint')+'</th><th>GB Nord</th><th>GB Est</th></tr></thead><tbody id="pregeoCoordBody"></tbody></table>';

  html+='<div class="pregeo-row"><div class="pregeo-label">'+t('pregeoSup')+'</div><div class="pregeo-value" style="font-weight:700;color:var(--accent-green)">'+t('pregeoSupVal')+'</div></div>';
  html+='<div class="pregeo-row"><div class="pregeo-label">'+t('pregeoPrecision')+'</div><div class="pregeo-value">'+t('pregeoPrecisionVal')+'</div></div>';

  dataEl.innerHTML=html;

  /* Animate coordinate rows */
  var coordBody=$('pregeoCoordBody');
  surveyPoints.forEach(function(p,i){
    var gbN=(p.n+500).toFixed(2);
    var gbE=(p.e+300).toFixed(2);
    var tr=document.createElement('tr');
    tr.innerHTML='<td><strong>'+p.id+'</strong></td><td>'+gbN+'</td><td>'+gbE+'</td>';
    coordBody.appendChild(tr);
    setTimeout(function(){tr.classList.add('visible')},200+i*100);
  });

  /* Draw PREGEO map */
  setTimeout(function(){drawPregeoMap()},300);
  setTimeout(enableNext,200+surveyPoints.length*100+600);
}

function drawPregeoMap(){
  var container=$('pregeoMap');
  var minN=Infinity,maxN=-Infinity,minE=Infinity,maxE=-Infinity;
  surveyPoints.forEach(function(p){
    if(p.n<minN)minN=p.n;if(p.n>maxN)maxN=p.n;
    if(p.e<minE)minE=p.e;if(p.e>maxE)maxE=p.e;
  });
  var rangeN=maxN-minN||1,rangeE=maxE-minE||1;
  var pad=50,w=container.clientWidth||400,h=container.clientHeight||320;
  var scale=Math.min((w-2*pad)/rangeE,(h-2*pad)/rangeN)*0.7;
  var cx=w/2,cy=h/2;
  var ctrE=(minE+maxE)/2,ctrN=(minN+maxN)/2;

  var pts=surveyPoints.map(function(p){
    return{x:cx+(p.e-ctrE)*scale,y:cy-(p.n-ctrN)*scale,id:p.id};
  });

  var svg='<svg width="'+w+'" height="'+h+'" xmlns="http://www.w3.org/2000/svg" style="font-family:var(--font-body)">';
  /* Catasto-style grid */
  for(var gx=0;gx<w;gx+=50)svg+='<line x1="'+gx+'" y1="0" x2="'+gx+'" y2="'+h+'" stroke="var(--border)" stroke-width="0.3"/>';
  for(var gy=0;gy<h;gy+=50)svg+='<line x1="0" y1="'+gy+'" x2="'+w+'" y2="'+gy+'" stroke="var(--border)" stroke-width="0.3"/>';

  /* Neighboring parcels (dotted outlines) */
  var offsets=[{dx:-60,dy:-40,w:55,h:45},{dx:50,dy:-35,w:50,h:40},{dx:-55,dy:40,w:60,h:35},{dx:55,dy:45,w:45,h:50}];
  offsets.forEach(function(o){
    var nx=cx+o.dx,ny=cy+o.dy;
    svg+='<rect x="'+nx+'" y="'+ny+'" width="'+o.w+'" height="'+o.h+'" fill="none" stroke="var(--silver)" stroke-width="1" stroke-dasharray="4,3" rx="2"/>';
    svg+='<text x="'+(nx+o.w/2)+'" y="'+(ny+o.h/2+3)+'" text-anchor="middle" fill="var(--silver)" font-size="8">P.'+(Math.floor(Math.random()*900)+100)+'</text>';
  });

  /* Main parcel polygon */
  var polyStr=pts.map(function(p){return p.x+','+p.y}).join(' ');
  svg+='<polygon points="'+polyStr+'" fill="rgba(15,23,42,0.08)" stroke="var(--navy)" stroke-width="2.5" stroke-linejoin="round"><animate attributeName="stroke-dashoffset" from="1000" to="0" dur="2s" fill="freeze"/></polygon>';

  /* Boundary lines with distances */
  for(var i=0;i<pts.length;i++){
    var j=(i+1)%pts.length;
    var mx=(pts[i].x+pts[j].x)/2,my=(pts[i].y+pts[j].y)/2;
    svg+='<text x="'+mx+'" y="'+(my-5)+'" text-anchor="middle" fill="var(--navy)" font-size="8" font-weight="600" opacity="0"><animate attributeName="opacity" from="0" to="1" begin="'+(0.5+i*0.2)+'s" dur="0.3s" fill="freeze"/>'+surveyPoints[i].dist.toFixed(1)+'</text>';
  }

  /* Points */
  pts.forEach(function(p,i){
    svg+='<circle cx="'+p.x+'" cy="'+p.y+'" r="4" fill="var(--navy)" stroke="var(--white)" stroke-width="1.5" opacity="0"><animate attributeName="opacity" from="0" to="1" begin="'+(i*0.1)+'s" dur="0.3s" fill="freeze"/></circle>';
    svg+='<text x="'+(p.x+8)+'" y="'+(p.y-6)+'" fill="var(--navy)" font-size="9" font-weight="700" opacity="0"><animate attributeName="opacity" from="0" to="1" begin="'+(i*0.1+0.1)+'s" dur="0.2s" fill="freeze"/>'+p.id+'</text>';
  });

  /* Parcel label */
  svg+='<text x="'+cx+'" y="'+(cy+4)+'" text-anchor="middle" fill="var(--navy)" font-size="12" font-weight="700" opacity="0"><animate attributeName="opacity" from="0" to="1" begin="1s" dur="0.5s" fill="freeze"/>P. 345</text>';

  /* North arrow */
  svg+='<g transform="translate('+(w-30)+',30)"><polygon points="0,-14 -5,0 5,0" fill="var(--navy)"/><text x="0" y="12" text-anchor="middle" fill="var(--navy)" font-size="9" font-weight="700">N</text></g>';

  /* Scale bar */
  var scaleBarLen=10*scale;
  if(scaleBarLen>20){
    svg+='<g transform="translate(20,'+(h-20)+')">';
    svg+='<line x1="0" y1="0" x2="'+scaleBarLen+'" y2="0" stroke="var(--navy)" stroke-width="2"/>';
    svg+='<line x1="0" y1="-4" x2="0" y2="4" stroke="var(--navy)" stroke-width="1.5"/>';
    svg+='<line x1="'+scaleBarLen+'" y1="-4" x2="'+scaleBarLen+'" y2="4" stroke="var(--navy)" stroke-width="1.5"/>';
    svg+='<text x="'+(scaleBarLen/2)+'" y="-6" text-anchor="middle" fill="var(--navy)" font-size="9" font-weight="600">10m</text>';
    svg+='</g>';
  }

  svg+='</svg>';
  container.innerHTML=svg;
}

/* ============ STEP 4 ============ */
function animateStep4(){
  var pkgItems=[
    {icon:'\u2705',text:t('pkgDocfa'),cls:'green'},
    {icon:'\u2705',text:t('pkgPregeo'),cls:'green'},
    {icon:'\u2705',text:t('pkgPlan'),cls:'green'},
    {icon:'\u2705',text:t('pkgReport'),cls:'green'}
  ];
  var chkItems=[
    {icon:'\u2705',text:t('chkFormat'),cls:'green'},
    {icon:'\u2705',text:t('chkCoherence'),cls:'green'},
    {icon:'\u2705',text:t('chkSurface'),cls:'green'},
    {icon:'\u23F3',text:t('chkSignature'),cls:'amber'}
  ];

  var pkgList=$('packageList');
  pkgList.innerHTML='';
  pkgItems.forEach(function(item,i){
    var el=document.createElement('div');
    el.className='submission-item';
    el.innerHTML='<div class="si-icon '+item.cls+'">'+item.icon+'</div><span>'+item.text+'</span>';
    pkgList.appendChild(el);
    setTimeout(function(){el.classList.add('visible')},200+i*300);
  });

  var chkEl=$('checkList');
  chkEl.innerHTML='';
  chkItems.forEach(function(item,i){
    var el=document.createElement('div');
    el.className='submission-item';
    el.innerHTML='<div class="si-icon '+item.cls+'">'+item.icon+'</div><span>'+item.text+'</span>';
    chkEl.appendChild(el);
    setTimeout(function(){el.classList.add('visible')},200+pkgItems.length*300+200+i*300);
  });

  var totalDelay=200+pkgItems.length*300+200+chkItems.length*300+400;
  setTimeout(function(){
    $('statusBadge').style.opacity='1';
  },totalDelay);
  setTimeout(function(){
    $('ctaSection').style.opacity='1';
  },totalDelay+300);
}

/* Init */
applyI18n();
updateProgress();
animateStep1();
})();
</script>
</body>
</html>
